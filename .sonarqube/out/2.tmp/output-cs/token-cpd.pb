å
_/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/DbContexts/ApplicationDbContext.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "

DbContexts" ,
;, -
public 
class  
ApplicationDbContext !
:! "
IdentityDbContext# 4
<4 5
ApplicationUser5 D
>D E
{ 
public		 
 
ApplicationDbContext		 
(		  
DbContextOptions		  0
<		0 1 
ApplicationDbContext		1 E
>		E F
options		G N
)		N O
:		O P
base		Q U
(		U V
options		V ]
)		] ^
{

 
} 
} ˛<
Y/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Initializer/DbInitializer.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "
Initializer" -
;- .
public		 
class		 
DbInitializer		 
:		 
IDbInitializer		 *
{

 
private 
readonly  
ApplicationDbContext )
_db* -
;- .
private 
readonly 
UserManager  
<  !
ApplicationUser! 0
>0 1
_userManager2 >
;> ?
private 
readonly 
RoleManager  
<  !
IdentityRole! -
>- .
_roleManager/ ;
;; <
public 

DbInitializer 
(  
ApplicationDbContext -
db. 0
,0 1
UserManager2 =
<= >
ApplicationUser> M
>M N
userManagerO Z
,Z [
RoleManager\ g
<g h
IdentityRoleh t
>t u
roleManager	v Å
)
Å Ç
{ 
_db 
= 
db 
; 
_userManager 
= 
userManager "
;" #
_roleManager 
= 
roleManager "
;" #
} 
public 

void 

Initialize 
( 
) 
{ 
if 

( 
_roleManager 
. 
FindByNameAsync (
(( )
SD) +
.+ ,
Admin, 1
)1 2
.2 3
Result3 9
==: <
null= A
)A B
{ 	
_roleManager 
. 
CreateAsync $
($ %
new% (
IdentityRole) 5
(5 6
SD6 8
.8 9
Admin9 >
)> ?
)? @
.@ A

GetAwaiterA K
(K L
)L M
.M N
	GetResultN W
(W X
)X Y
;Y Z
_roleManager 
. 
CreateAsync $
($ %
new% (
IdentityRole) 5
(5 6
SD6 8
.8 9
Customer9 A
)A B
)B C
.C D

GetAwaiterD N
(N O
)O P
.P Q
	GetResultQ Z
(Z [
)[ \
;\ ]
} 	
else 
{ 	
return 
; 
}   	
ApplicationUser"" 
	adminUser"" !
=""" #
new""$ '
ApplicationUser""( 7
(""7 8
)""8 9
{## 	
UserName$$ 
=$$ 
$str$$ )
,$$) *
Email%% 
=%% 
$str%% &
,%%& '
EmailConfirmed&& 
=&& 
true&& !
,&&! "
PhoneNumber'' 
='' 
$str'' &
,''& '
	FirstName(( 
=(( 
$str(( 
,(( 
LastName)) 
=)) 
$str)) 
}** 	
;**	 

_userManager,, 
.,, 
CreateAsync,,  
(,,  !
	adminUser,,! *
,,,* +
$str,,, 7
),,7 8
.,,8 9

GetAwaiter,,9 C
(,,C D
),,D E
.,,E F
	GetResult,,F O
(,,O P
),,P Q
;,,Q R
_userManager-- 
.-- 
AddToRoleAsync-- #
(--# $
	adminUser--$ -
,--- .
SD--/ 1
.--1 2
Admin--2 7
)--7 8
.--8 9

GetAwaiter--9 C
(--C D
)--D E
.--E F
	GetResult--F O
(--O P
)--P Q
;--Q R
var// 
temp1// 
=// 
_userManager//  
.//  !
AddClaimsAsync//! /
(/// 0
	adminUser//0 9
,//9 :
new//; >
[//> ?
]//? @
{00 	
new11 
Claim11 
(11 
JwtClaimTypes11 #
.11# $
Name11$ (
,11( )
	adminUser11* 3
.113 4
	FirstName114 =
+11> ?
$str11@ C
+11D E
	adminUser11F O
.11O P
LastName11P X
)11X Y
,11Y Z
new22 
Claim22 
(22 
JwtClaimTypes22 #
.22# $
	GivenName22$ -
,22- .
	adminUser22/ 8
.228 9
	FirstName229 B
)22B C
,22C D
new33 
Claim33 
(33 
JwtClaimTypes33 #
.33# $

FamilyName33$ .
,33. /
	adminUser330 9
.339 :
LastName33: B
)33B C
,33C D
new44 
Claim44 
(44 
JwtClaimTypes44 #
.44# $
Role44$ (
,44( )
SD44* ,
.44, -
Admin44- 2
)442 3
,443 4
}55 	
)55	 

.55
 
Result55 
;55 
ApplicationUser77 
customerUser77 $
=77% &
new77' *
ApplicationUser77+ :
(77: ;
)77; <
{88 	
UserName99 
=99 
$str99 ,
,99, -
Email:: 
=:: 
$str:: )
,::) *
EmailConfirmed;; 
=;; 
true;; !
,;;! "
PhoneNumber<< 
=<< 
$str<< &
,<<& '
	FirstName== 
=== 
$str== 
,== 
LastName>> 
=>> 
$str>> 
}?? 	
;??	 

_userManagerAA 
.AA 
CreateAsyncAA  
(AA  !
customerUserAA! -
,AA- .
$strAA/ =
)AA= >
.AA> ?

GetAwaiterAA? I
(AAI J
)AAJ K
.AAK L
	GetResultAAL U
(AAU V
)AAV W
;AAW X
_userManagerBB 
.BB 
AddToRoleAsyncBB #
(BB# $
customerUserBB$ 0
,BB0 1
SDBB2 4
.BB4 5
CustomerBB5 =
)BB= >
.BB> ?

GetAwaiterBB? I
(BBI J
)BBJ K
.BBK L
	GetResultBBL U
(BBU V
)BBV W
;BBW X
varDD 
temp2DD 
=DD 
_userManagerDD  
.DD  !
AddClaimsAsyncDD! /
(DD/ 0
customerUserDD0 <
,DD< =
newDD> A
[DDA B
]DDB C
{EE 	
newFF 
ClaimFF 
(FF 
JwtClaimTypesFF #
.FF# $
NameFF$ (
,FF( )
customerUserFF* 6
.FF6 7
	FirstNameFF7 @
+FFA B
$strFFC F
+FFG H
customerUserFFI U
.FFU V
LastNameFFV ^
)FF^ _
,FF_ `
newGG 
ClaimGG 
(GG 
JwtClaimTypesGG #
.GG# $
	GivenNameGG$ -
,GG- .
customerUserGG/ ;
.GG; <
	FirstNameGG< E
)GGE F
,GGF G
newHH 
ClaimHH 
(HH 
JwtClaimTypesHH #
.HH# $

FamilyNameHH$ .
,HH. /
customerUserHH0 <
.HH< =
LastNameHH= E
)HHE F
,HHF G
newII 
ClaimII 
(II 
JwtClaimTypesII #
.II# $
RoleII$ (
,II( )
SDII* ,
.II, -
CustomerII- 5
)II5 6
,II6 7
}JJ 	
)JJ	 

.JJ
 
ResultJJ 
;JJ 
}LL 
}MM œ
Z/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Initializer/IDbInitializer.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "
Initializer" -
;- .
public 
	interface 
IDbInitializer 
{ 
public 

void 

Initialize 
( 
) 
; 
} ∆—
d/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/AccountController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[   
SecurityHeaders   
]   
[!! 
AllowAnonymous!! 
]!! 
public"" 

class"" 
AccountController"" "
:""# $

Controller""% /
{## 
private$$ 
readonly$$ 
UserManager$$ $
<$$$ %
ApplicationUser$$% 4
>$$4 5
_userManager$$6 B
;$$B C
private%% 
readonly%% 
SignInManager%% &
<%%& '
ApplicationUser%%' 6
>%%6 7
_signInManager%%8 F
;%%F G
private&& 
readonly&& 
RoleManager&& $
<&&$ %
IdentityRole&&% 1
>&&1 2
_roleManager&&3 ?
;&&? @
private(( 
readonly(( -
!IIdentityServerInteractionService(( :
_interaction((; G
;((G H
private)) 
readonly)) 
IClientStore)) %
_clientStore))& 2
;))2 3
private** 
readonly** )
IAuthenticationSchemeProvider** 6
_schemeProvider**7 F
;**F G
private++ 
readonly++ "
IIdentityProviderStore++ /"
_identityProviderStore++0 F
;++F G
private,, 
readonly,, 
IEventService,, &
_events,,' .
;,,. /
public.. 
AccountController..  
(..  !-
!IIdentityServerInteractionService// -
interaction//. 9
,//9 :
IClientStore00 
clientStore00 $
,00$ %)
IAuthenticationSchemeProvider11 )
schemeProvider11* 8
,118 9"
IIdentityProviderStore22 "!
identityProviderStore22# 8
,228 9
IEventService33 
events33  
,33  !
UserManager44 
<44 
ApplicationUser44 '
>44' (
userManager44) 4
,444 5
SignInManager55 
<55 
ApplicationUser55 )
>55) *
signInManager55+ 8
,558 9
RoleManager66 
<66 
IdentityRole66 $
>66$ %
roleManager66& 1
)77 
{88 	
_interaction99 
=99 
interaction99 &
;99& '
_clientStore:: 
=:: 
clientStore:: &
;::& '
_schemeProvider;; 
=;; 
schemeProvider;; ,
;;;, -"
_identityProviderStore<< "
=<<# $!
identityProviderStore<<% :
;<<: ;
_events== 
=== 
events== 
;== 
_userManager>> 
=>> 
userManager>> &
;>>& '
_signInManager?? 
=?? 
signInManager?? *
;??* +
_roleManager@@ 
=@@ 
roleManager@@ &
;@@& '
}AA 	
[FF 	
HttpGetFF	 
]FF 
publicGG 
asyncGG 
TaskGG 
<GG 
IActionResultGG '
>GG' (
LoginGG) .
(GG. /
stringGG/ 5
	returnUrlGG6 ?
)GG? @
{HH 	
varJJ 
vmJJ 
=JJ 
awaitJJ $
BuildLoginViewModelAsyncJJ 3
(JJ3 4
	returnUrlJJ4 =
)JJ= >
;JJ> ?
ifLL 
(LL 
vmLL 
.LL 
IsExternalLoginOnlyLL &
)LL& '
{MM 
returnOO 
RedirectToActionOO '
(OO' (
$strOO( 3
,OO3 4
$strOO5 ?
,OO? @
newOOA D
{OOE F
schemeOOG M
=OON O
vmOOP R
.OOR S
ExternalLoginSchemeOOS f
,OOf g
	returnUrlOOh q
}OOr s
)OOs t
;OOt u
}PP 
returnRR 
ViewRR 
(RR 
vmRR 
)RR 
;RR 
}SS 	
[XX 	
HttpPostXX	 
]XX 
[YY 	$
ValidateAntiForgeryTokenYY	 !
]YY! "
publicZZ 
asyncZZ 
TaskZZ 
<ZZ 
IActionResultZZ '
>ZZ' (
LoginZZ) .
(ZZ. /
LoginInputModelZZ/ >
modelZZ? D
,ZZD E
stringZZF L
buttonZZM S
)ZZS T
{[[ 	
var]] 
context]] 
=]] 
await]] 
_interaction]]  ,
.]], -(
GetAuthorizationContextAsync]]- I
(]]I J
model]]J O
.]]O P
	ReturnUrl]]P Y
)]]Y Z
;]]Z [
if`` 
(`` 
button`` 
!=`` 
$str`` !
)``! "
{aa 
ifbb 
(bb 
contextbb 
!=bb 
nullbb #
)bb# $
{cc 
awaitgg 
_interactiongg &
.gg& '"
DenyAuthorizationAsyncgg' =
(gg= >
contextgg> E
,ggE F
AuthorizationErrorggG Y
.ggY Z
AccessDeniedggZ f
)ggf g
;ggg h
ifjj 
(jj 
contextjj 
.jj  
IsNativeClientjj  .
(jj. /
)jj/ 0
)jj0 1
{kk 
returnnn 
thisnn #
.nn# $
LoadingPagenn$ /
(nn/ 0
$strnn0 :
,nn: ;
modelnn< A
.nnA B
	ReturnUrlnnB K
)nnK L
;nnL M
}oo 
returnqq 
Redirectqq #
(qq# $
modelqq$ )
.qq) *
	ReturnUrlqq* 3
)qq3 4
;qq4 5
}rr 
elsess 
{tt 
returnvv 
Redirectvv #
(vv# $
$strvv$ (
)vv( )
;vv) *
}ww 
}xx 
ifzz 
(zz 

ModelStatezz 
.zz 
IsValidzz "
)zz" #
{{{ 
var|| 
result|| 
=|| 
await|| "
_signInManager||# 1
.||1 2
PasswordSignInAsync||2 E
(||E F
model||F K
.||K L
Username||L T
,||T U
model||V [
.||[ \
Password||\ d
,||d e
model}} 
.}} 
RememberLogin}} '
,}}' (
lockoutOnFailure}}) 9
:}}9 :
false}}; @
)}}@ A
;}}A B
if~~ 
(~~ 
result~~ 
.~~ 
	Succeeded~~ $
)~~$ %
{ 
var
ÄÄ 
user
ÄÄ 
=
ÄÄ 
await
ÄÄ $
_userManager
ÄÄ% 1
.
ÄÄ1 2
FindByNameAsync
ÄÄ2 A
(
ÄÄA B
model
ÄÄB G
.
ÄÄG H
Username
ÄÄH P
)
ÄÄP Q
;
ÄÄQ R
await
ÅÅ 
_events
ÅÅ !
.
ÅÅ! "

RaiseAsync
ÅÅ" ,
(
ÅÅ, -
new
ÅÅ- 0#
UserLoginSuccessEvent
ÅÅ1 F
(
ÅÅF G
user
ÅÅG K
.
ÅÅK L
UserName
ÅÅL T
,
ÅÅT U
user
ÅÅV Z
.
ÅÅZ [
Id
ÅÅ[ ]
,
ÅÅ] ^
user
ÇÇ 
.
ÇÇ 
UserName
ÇÇ %
,
ÇÇ% &
clientId
ÇÇ' /
:
ÇÇ/ 0
context
ÇÇ1 8
?
ÇÇ8 9
.
ÇÇ9 :
Client
ÇÇ: @
.
ÇÇ@ A
ClientId
ÇÇA I
)
ÇÇI J
)
ÇÇJ K
;
ÇÇK L
if
ÑÑ 
(
ÑÑ 
context
ÑÑ 
!=
ÑÑ  "
null
ÑÑ# '
)
ÑÑ' (
{
ÖÖ 
return
ÜÜ 
Redirect
ÜÜ '
(
ÜÜ' (
model
ÜÜ( -
.
ÜÜ- .
	ReturnUrl
ÜÜ. 7
)
ÜÜ7 8
;
ÜÜ8 9
}
áá 
if
ââ 
(
ââ 
Url
ââ 
.
ââ 

IsLocalUrl
ââ &
(
ââ& '
model
ââ' ,
.
ââ, -
	ReturnUrl
ââ- 6
)
ââ6 7
)
ââ7 8
{
ää 
return
ãã 
Redirect
ãã '
(
ãã' (
model
ãã( -
.
ãã- .
	ReturnUrl
ãã. 7
)
ãã7 8
;
ãã8 9
}
åå 
else
çç 
if
çç 
(
çç 
string
çç #
.
çç# $
IsNullOrEmpty
çç$ 1
(
çç1 2
model
çç2 7
.
çç7 8
	ReturnUrl
çç8 A
)
ççA B
)
ççB C
{
éé 
return
èè 
Redirect
èè '
(
èè' (
$str
èè( ,
)
èè, -
;
èè- .
}
êê 
else
ëë 
{
íí 
throw
ìì 
new
ìì !
	Exception
ìì" +
(
ìì+ ,
$str
ìì, @
)
ìì@ A
;
ììA B
}
îî 
}
ññ 
await
òò 
_events
òò 
.
òò 

RaiseAsync
òò (
(
òò( )
new
òò) ,#
UserLoginFailureEvent
òò- B
(
òòB C
model
òòC H
.
òòH I
Username
òòI Q
,
òòQ R
$str
òòS h
,
òòh i
clientId
òòj r
:
òòr s
context
òòs z
?
òòz {
.
òò{ |
Clientòò| Ç
.òòÇ É
ClientIdòòÉ ã
)òòã å
)òòå ç
;òòç é

ModelState
ôô 
.
ôô 
AddModelError
ôô (
(
ôô( )
string
ôô) /
.
ôô/ 0
Empty
ôô0 5
,
ôô5 6
AccountOptions
ôô7 E
.
ôôE F,
InvalidCredentialsErrorMessage
ôôF d
)
ôôd e
;
ôôe f
}
öö 
var
ùù 
vm
ùù 
=
ùù 
await
ùù &
BuildLoginViewModelAsync
ùù 3
(
ùù3 4
model
ùù4 9
)
ùù9 :
;
ùù: ;
return
ûû 
View
ûû 
(
ûû 
vm
ûû 
)
ûû 
;
ûû 
}
üü 	
[
•• 	
HttpGet
••	 
]
•• 
public
¶¶ 
async
¶¶ 
Task
¶¶ 
<
¶¶ 
IActionResult
¶¶ '
>
¶¶' (
Logout
¶¶) /
(
¶¶/ 0
string
¶¶0 6
logoutId
¶¶7 ?
)
¶¶? @
{
ßß 	
var
©© 
vm
©© 
=
©© 
await
©© '
BuildLogoutViewModelAsync
©© 4
(
©©4 5
logoutId
©©5 =
)
©©= >
;
©©> ?
if
´´ 
(
´´ 
vm
´´ 
.
´´ 
ShowLogoutPrompt
´´ #
==
´´$ &
false
´´' ,
)
´´, -
{
¨¨ 
return
ØØ 
await
ØØ 
Logout
ØØ #
(
ØØ# $
vm
ØØ$ &
)
ØØ& '
;
ØØ' (
}
∞∞ 
return
≤≤ 
View
≤≤ 
(
≤≤ 
vm
≤≤ 
)
≤≤ 
;
≤≤ 
}
≥≥ 	
[
∏∏ 	
HttpPost
∏∏	 
]
∏∏ 
[
ππ 	&
ValidateAntiForgeryToken
ππ	 !
]
ππ! "
public
∫∫ 
async
∫∫ 
Task
∫∫ 
<
∫∫ 
IActionResult
∫∫ '
>
∫∫' (
Logout
∫∫) /
(
∫∫/ 0
LogoutInputModel
∫∫0 @
model
∫∫A F
)
∫∫F G
{
ªª 	
var
ΩΩ 
vm
ΩΩ 
=
ΩΩ 
await
ΩΩ *
BuildLoggedOutViewModelAsync
ΩΩ 7
(
ΩΩ7 8
model
ΩΩ8 =
.
ΩΩ= >
LogoutId
ΩΩ> F
)
ΩΩF G
;
ΩΩG H
if
øø 
(
øø 
User
øø 
?
øø 
.
øø 
Identity
øø 
.
øø 
IsAuthenticated
øø .
==
øø/ 1
true
øø2 6
)
øø6 7
{
¿¿ 
await
¬¬ 
_signInManager
¬¬ $
.
¬¬$ %
SignOutAsync
¬¬% 1
(
¬¬1 2
)
¬¬2 3
;
¬¬3 4
await
≈≈ 
_events
≈≈ 
.
≈≈ 

RaiseAsync
≈≈ (
(
≈≈( )
new
≈≈) ,$
UserLogoutSuccessEvent
≈≈- C
(
≈≈C D
User
≈≈D H
.
≈≈H I
GetSubjectId
≈≈I U
(
≈≈U V
)
≈≈V W
,
≈≈W X
User
≈≈Y ]
.
≈≈] ^
GetDisplayName
≈≈^ l
(
≈≈l m
)
≈≈m n
)
≈≈n o
)
≈≈o p
;
≈≈p q
}
∆∆ 
if
…… 
(
…… 
vm
…… 
.
…… $
TriggerExternalSignout
…… )
)
……) *
{
   
string
ŒŒ 
url
ŒŒ 
=
ŒŒ 
Url
ŒŒ  
.
ŒŒ  !
Action
ŒŒ! '
(
ŒŒ' (
$str
ŒŒ( 0
,
ŒŒ0 1
new
ŒŒ2 5
{
ŒŒ6 7
logoutId
ŒŒ8 @
=
ŒŒA B
vm
ŒŒC E
.
ŒŒE F
LogoutId
ŒŒF N
}
ŒŒO P
)
ŒŒP Q
;
ŒŒQ R
return
—— 
SignOut
—— 
(
—— 
new
—— "&
AuthenticationProperties
——# ;
{
——< =
RedirectUri
——> I
=
——J K
url
——L O
}
——P Q
,
——Q R
vm
——S U
.
——U V*
ExternalAuthenticationScheme
——V r
)
——r s
;
——s t
}
““ 
return
‘‘ 
View
‘‘ 
(
‘‘ 
$str
‘‘ #
,
‘‘# $
vm
‘‘% '
)
‘‘' (
;
‘‘( )
}
’’ 	
[
◊◊ 	
HttpGet
◊◊	 
]
◊◊ 
public
ÿÿ 
IActionResult
ÿÿ 
AccessDenied
ÿÿ )
(
ÿÿ) *
)
ÿÿ* +
{
ŸŸ 	
return
⁄⁄ 
View
⁄⁄ 
(
⁄⁄ 
)
⁄⁄ 
;
⁄⁄ 
}
€€ 	
[
››	 

HttpGet
››
 
]
›› 
public
ﬁﬁ 
async
ﬁﬁ 
Task
ﬁﬁ 
<
ﬁﬁ 
IActionResult
ﬁﬁ '
>
ﬁﬁ' (
Register
ﬁﬁ) 1
(
ﬁﬁ1 2
string
ﬁﬁ2 8
	returnUrl
ﬁﬁ9 B
)
ﬁﬁB C
{
ﬂﬂ 	
var
·· 
vm
·· 
=
·· 
await
·· )
BuildRegisterViewModelAsync
·· 6
(
··6 7
	returnUrl
··7 @
)
··@ A
;
··A B
return
„„ 
View
„„ 
(
„„ 
vm
„„ 
)
„„ 
;
„„ 
}
‰‰ 	
[
ÊÊ 	
HttpPost
ÊÊ	 
]
ÊÊ 
[
ÁÁ 	
AllowAnonymous
ÁÁ	 
]
ÁÁ 
[
ËË 	&
ValidateAntiForgeryToken
ËË	 !
]
ËË! "
public
ÈÈ 
async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
IActionResult
ÈÈ '
>
ÈÈ' (
Register
ÈÈ) 1
(
ÈÈ1 2
RegisterViewModel
ÈÈ2 C
model
ÈÈD I
,
ÈÈI J
string
ÈÈK Q
	returnUrl
ÈÈR [
=
ÈÈ\ ]
null
ÈÈ^ b
)
ÈÈb c
{
ÍÍ 	
ViewData
ÎÎ 
[
ÎÎ 
$str
ÎÎ  
]
ÎÎ  !
=
ÎÎ" #
	returnUrl
ÎÎ$ -
;
ÎÎ- .
if
ÏÏ 
(
ÏÏ 

ModelState
ÏÏ 
.
ÏÏ 
IsValid
ÏÏ "
)
ÏÏ" #
{
ÌÌ 
var
ÔÔ 
user
ÔÔ 
=
ÔÔ 
new
ÔÔ 
ApplicationUser
ÔÔ .
{
 
UserName
ÒÒ 
=
ÒÒ 
model
ÒÒ $
.
ÒÒ$ %
Username
ÒÒ% -
,
ÒÒ- .
Email
ÚÚ 
=
ÚÚ 
model
ÚÚ !
.
ÚÚ! "
Email
ÚÚ" '
,
ÚÚ' (
EmailConfirmed
ÛÛ "
=
ÛÛ# $
true
ÛÛ% )
,
ÛÛ) *
	FirstName
ÙÙ 
=
ÙÙ 
model
ÙÙ #
.
ÙÙ# $
	FirstName
ÙÙ$ -
,
ÙÙ- .
LastName
ıı 
=
ıı 
model
ıı "
.
ıı" #
LastNAme
ıı# +
}
ˆˆ 
;
ˆˆ 
var
¯¯ 
result
¯¯ 
=
¯¯ 
await
¯¯ "
_userManager
¯¯# /
.
¯¯/ 0
CreateAsync
¯¯0 ;
(
¯¯; <
user
¯¯< @
,
¯¯@ A
model
¯¯B G
.
¯¯G H
Password
¯¯H P
)
¯¯P Q
;
¯¯Q R
if
˘˘ 
(
˘˘ 
result
˘˘ 
.
˘˘ 
	Succeeded
˘˘ $
)
˘˘$ %
{
˙˙ 
if
˚˚ 
(
˚˚ 
!
˚˚ 
_roleManager
˚˚ %
.
˚˚% &
RoleExistsAsync
˚˚& 5
(
˚˚5 6
model
˚˚6 ;
.
˚˚; <
RoleName
˚˚< D
)
˚˚D E
.
˚˚E F

GetAwaiter
˚˚F P
(
˚˚P Q
)
˚˚Q R
.
˚˚R S
	GetResult
˚˚S \
(
˚˚\ ]
)
˚˚] ^
)
˚˚^ _
{
¸¸ 
var
˝˝ 
userRole
˝˝ $
=
˝˝% &
new
˝˝' *
IdentityRole
˝˝+ 7
{
˛˛ 
Name
ˇˇ  
=
ˇˇ! "
model
ˇˇ# (
.
ˇˇ( )
RoleName
ˇˇ) 1
,
ˇˇ1 2
NormalizedName
ÄÄ *
=
ÄÄ+ ,
model
ÄÄ- 2
.
ÄÄ2 3
RoleName
ÄÄ3 ;
,
ÄÄ; <
}
ÇÇ 
;
ÇÇ 
await
ÉÉ 
_roleManager
ÉÉ *
.
ÉÉ* +
CreateAsync
ÉÉ+ 6
(
ÉÉ6 7
userRole
ÉÉ7 ?
)
ÉÉ? @
;
ÉÉ@ A
}
ÑÑ 
await
ÜÜ 
_userManager
ÜÜ &
.
ÜÜ& '
AddToRoleAsync
ÜÜ' 5
(
ÜÜ5 6
user
ÜÜ6 :
,
ÜÜ: ;
model
ÜÜ< A
.
ÜÜA B
RoleName
ÜÜB J
)
ÜÜJ K
;
ÜÜK L
await
àà 
_userManager
àà &
.
àà& '
AddClaimsAsync
àà' 5
(
àà5 6
user
àà6 :
,
àà: ;
new
àà< ?
Claim
àà@ E
[
ààE F
]
ààF G
{
ààG H
new
ââ 
Claim
ââ  %
(
ââ% &
JwtClaimTypes
ââ& 3
.
ââ3 4
Name
ââ4 8
,
ââ8 9
model
ââ: ?
.
ââ? @
Username
ââ@ H
)
ââH I
,
ââI J
new
ää 
Claim
ää  %
(
ää% &
JwtClaimTypes
ää& 3
.
ää3 4
Email
ää4 9
,
ää9 :
model
ää; @
.
ää@ A
Email
ääA F
)
ääF G
,
ääG H
new
ãã 
Claim
ãã  %
(
ãã% &
JwtClaimTypes
ãã& 3
.
ãã3 4
	GivenName
ãã4 =
,
ãã= >
model
ãã? D
.
ããD E
	FirstName
ããE N
)
ããN O
,
ããO P
new
åå 
Claim
åå  %
(
åå% &
JwtClaimTypes
åå& 3
.
åå3 4

FamilyName
åå4 >
,
åå> ?
model
åå@ E
.
ååE F
LastNAme
ååF N
)
ååN O
,
ååO P
new
çç 
Claim
çç  %
(
çç% &
JwtClaimTypes
çç& 3
.
çç3 4
WebSite
çç4 ;
,
çç; <
$str
çç= F
+
ççF G
model
ççG L
.
ççL M
Username
ççM U
+
ççU V
$str
ççV \
)
çç\ ]
,
çç] ^
new
éé 
Claim
éé  %
(
éé% &
JwtClaimTypes
éé& 3
.
éé3 4
Role
éé4 8
,
éé8 9
$str
éé9 ?
)
éé? @
}
ééA B
)
ééB C
;
ééC D
var
êê 
context
êê 
=
êê  !
await
êê" '
_interaction
êê( 4
.
êê4 5*
GetAuthorizationContextAsync
êê5 Q
(
êêQ R
model
êêR W
.
êêW X
	ReturnUrl
êêX a
)
êêa b
;
êêb c
var
ëë 
loginresult
ëë #
=
ëë$ %
await
ëë& +
_signInManager
ëë, :
.
ëë: ;!
PasswordSignInAsync
ëë; N
(
ëëN O
model
ëëO T
.
ëëT U
Username
ëëU ]
,
ëë] ^
model
ëë_ d
.
ëëd e
Password
ëëe m
,
ëëm n
false
ëëo t
,
ëët u
lockoutOnFailureëëv Ü
:ëëÜ á
trueëëà å
)ëëå ç
;ëëç é
if
íí 
(
íí 
loginresult
íí #
.
íí# $
	Succeeded
íí$ -
)
íí- .
{
ìì 
var
îî 
	checkuser
îî %
=
îî& '
await
îî( -
_userManager
îî. :
.
îî: ;
FindByNameAsync
îî; J
(
îîJ K
model
îîK P
.
îîP Q
Username
îîQ Y
)
îîY Z
;
îîZ [
await
ïï 
_events
ïï %
.
ïï% &

RaiseAsync
ïï& 0
(
ïï0 1
new
ïï1 4#
UserLoginSuccessEvent
ïï5 J
(
ïïJ K
	checkuser
ïïK T
.
ïïT U
UserName
ïïU ]
,
ïï] ^
	checkuser
ïï_ h
.
ïïh i
Id
ïïi k
,
ïïk l
	checkuser
ïïm v
.
ïïv w
UserName
ïïw 
,ïï Ä
clientIdïïÅ â
:ïïâ ä
contextïïã í
?ïïí ì
.ïïì î
Clientïïî ö
.ïïö õ
ClientIdïïõ £
)ïï£ §
)ïï§ •
;ïï• ¶
if
óó 
(
óó 
context
óó #
!=
óó$ &
null
óó' +
)
óó+ ,
{
òò 
if
ôô 
(
ôô  
context
ôô  '
.
ôô' (
IsNativeClient
ôô( 6
(
ôô6 7
)
ôô7 8
)
ôô8 9
{
öö 
return
ùù  &
this
ùù' +
.
ùù+ ,
LoadingPage
ùù, 7
(
ùù7 8
$str
ùù8 B
,
ùùB C
model
ùùD I
.
ùùI J
	ReturnUrl
ùùJ S
)
ùùS T
;
ùùT U
}
ûû 
return
°° "
Redirect
°°# +
(
°°+ ,
model
°°, 1
.
°°1 2
	ReturnUrl
°°2 ;
)
°°; <
;
°°< =
}
¢¢ 
if
•• 
(
•• 
Url
•• 
.
••  

IsLocalUrl
••  *
(
••* +
model
••+ 0
.
••0 1
	ReturnUrl
••1 :
)
••: ;
)
••; <
{
¶¶ 
return
ßß "
Redirect
ßß# +
(
ßß+ ,
model
ßß, 1
.
ßß1 2
	ReturnUrl
ßß2 ;
)
ßß; <
;
ßß< =
}
®® 
else
©© 
if
©© 
(
©©  !
string
©©! '
.
©©' (
IsNullOrEmpty
©©( 5
(
©©5 6
model
©©6 ;
.
©©; <
	ReturnUrl
©©< E
)
©©E F
)
©©F G
{
™™ 
return
´´ "
Redirect
´´# +
(
´´+ ,
$str
´´, 0
)
´´0 1
;
´´1 2
}
¨¨ 
else
≠≠ 
{
ÆÆ 
throw
∞∞ !
new
∞∞" %
	Exception
∞∞& /
(
∞∞/ 0
$str
∞∞0 D
)
∞∞D E
;
∞∞E F
}
±± 
}
≤≤ 
}
¥¥ 
}
µµ 
return
∏∏ 
View
∏∏ 
(
∏∏ 
model
∏∏ 
)
∏∏ 
;
∏∏ 
}
ππ 	
private
∫∫ 
async
∫∫ 
Task
∫∫ 
<
∫∫ 
RegisterViewModel
∫∫ ,
>
∫∫, -)
BuildRegisterViewModelAsync
∫∫. I
(
∫∫I J
string
∫∫J P
	returnUrl
∫∫Q Z
)
∫∫Z [
{
ªª 	
var
ºº 
context
ºº 
=
ºº 
await
ºº 
_interaction
ºº  ,
.
ºº, -*
GetAuthorizationContextAsync
ºº- I
(
ººI J
	returnUrl
ººJ S
)
ººS T
;
ººT U
List
ΩΩ 
<
ΩΩ 
string
ΩΩ 
>
ΩΩ 
roles
ΩΩ 
=
ΩΩ  
new
ΩΩ! $
List
ΩΩ% )
<
ΩΩ) *
string
ΩΩ* 0
>
ΩΩ0 1
(
ΩΩ1 2
)
ΩΩ2 3
;
ΩΩ3 4
roles
ææ 
.
ææ 
Add
ææ 
(
ææ 
$str
ææ 
)
ææ 
;
ææ 
roles
øø 
.
øø 
Add
øø 
(
øø 
$str
øø  
)
øø  !
;
øø! "
ViewBag
¿¿ 
.
¿¿ 
message
¿¿ 
=
¿¿ 
roles
¿¿ #
;
¿¿# $
if
¡¡ 
(
¡¡ 
context
¡¡ 
?
¡¡ 
.
¡¡ 
IdP
¡¡ 
!=
¡¡ 
null
¡¡  $
&&
¡¡% '
await
¡¡( -
_schemeProvider
¡¡. =
.
¡¡= >
GetSchemeAsync
¡¡> L
(
¡¡L M
context
¡¡M T
.
¡¡T U
IdP
¡¡U X
)
¡¡X Y
!=
¡¡Z \
null
¡¡] a
)
¡¡a b
{
¬¬ 
var
√√ 
local
√√ 
=
√√ 
context
√√ #
.
√√# $
IdP
√√$ '
==
√√( *
Duende
√√+ 1
.
√√1 2
IdentityServer
√√2 @
.
√√@ A%
IdentityServerConstants
√√A X
.
√√X Y#
LocalIdentityProvider
√√Y n
;
√√n o
var
∆∆ 
vm
∆∆ 
=
∆∆ 
new
∆∆ 
RegisterViewModel
∆∆ .
{
«« 
EnableLocalLogin
»» $
=
»»% &
local
»»' ,
,
»», -
	ReturnUrl
…… 
=
…… 
	returnUrl
……  )
,
……) *
Username
   
=
   
context
   &
?
  & '
.
  ' (
	LoginHint
  ( 1
,
  1 2
}
ÀÀ 
;
ÀÀ 
if
ÕÕ 
(
ÕÕ 
!
ÕÕ 
local
ÕÕ 
)
ÕÕ 
{
ŒŒ 
vm
œœ 
.
œœ 
ExternalProviders
œœ (
=
œœ) *
new
œœ+ .
[
œœ. /
]
œœ/ 0
{
œœ1 2
new
œœ3 6
ExternalProvider
œœ7 G
{
œœH I"
AuthenticationScheme
œœJ ^
=
œœ_ `
context
œœa h
.
œœh i
IdP
œœi l
}
œœm n
}
œœo p
;
œœp q
}
–– 
return
““ 
vm
““ 
;
““ 
}
”” 
var
’’ 
schemes
’’ 
=
’’ 
await
’’ 
_schemeProvider
’’  /
.
’’/ 0 
GetAllSchemesAsync
’’0 B
(
’’B C
)
’’C D
;
’’D E
var
◊◊ 
	providers
◊◊ 
=
◊◊ 
schemes
◊◊ #
.
ÿÿ 
Where
ÿÿ 
(
ÿÿ 
x
ÿÿ 
=>
ÿÿ 
x
ÿÿ 
.
ÿÿ 
DisplayName
ÿÿ )
!=
ÿÿ* ,
null
ÿÿ- 1
)
ÿÿ1 2
.
ŸŸ 
Select
ŸŸ 
(
ŸŸ 
x
ŸŸ 
=>
ŸŸ 
new
ŸŸ  
ExternalProvider
ŸŸ! 1
{
⁄⁄ 
DisplayName
€€ 
=
€€  !
x
€€" #
.
€€# $
DisplayName
€€$ /
??
€€0 2
x
€€3 4
.
€€4 5
Name
€€5 9
,
€€9 :"
AuthenticationScheme
‹‹ (
=
‹‹) *
x
‹‹+ ,
.
‹‹, -
Name
‹‹- 1
}
›› 
)
›› 
.
›› 
ToList
›› 
(
›› 
)
›› 
;
›› 
var
ﬂﬂ 

allowLocal
ﬂﬂ 
=
ﬂﬂ 
true
ﬂﬂ !
;
ﬂﬂ! "
if
‡‡ 
(
‡‡ 
context
‡‡ 
?
‡‡ 
.
‡‡ 
Client
‡‡ 
.
‡‡  
ClientId
‡‡  (
!=
‡‡) +
null
‡‡, 0
)
‡‡0 1
{
·· 
var
‚‚ 
client
‚‚ 
=
‚‚ 
await
‚‚ "
_clientStore
‚‚# /
.
‚‚/ 0(
FindEnabledClientByIdAsync
‚‚0 J
(
‚‚J K
context
‚‚K R
.
‚‚R S
Client
‚‚S Y
.
‚‚Y Z
ClientId
‚‚Z b
)
‚‚b c
;
‚‚c d
if
„„ 
(
„„ 
client
„„ 
!=
„„ 
null
„„ "
)
„„" #
{
‰‰ 

allowLocal
ÂÂ 
=
ÂÂ  
client
ÂÂ! '
.
ÂÂ' (
EnableLocalLogin
ÂÂ( 8
;
ÂÂ8 9
if
ÁÁ 
(
ÁÁ 
client
ÁÁ 
.
ÁÁ *
IdentityProviderRestrictions
ÁÁ ;
!=
ÁÁ< >
null
ÁÁ? C
&&
ÁÁD F
client
ÁÁG M
.
ÁÁM N*
IdentityProviderRestrictions
ÁÁN j
.
ÁÁj k
Any
ÁÁk n
(
ÁÁn o
)
ÁÁo p
)
ÁÁp q
{
ËË 
	providers
ÈÈ !
=
ÈÈ" #
	providers
ÈÈ$ -
.
ÈÈ- .
Where
ÈÈ. 3
(
ÈÈ3 4
provider
ÈÈ4 <
=>
ÈÈ= ?
client
ÈÈ@ F
.
ÈÈF G*
IdentityProviderRestrictions
ÈÈG c
.
ÈÈc d
Contains
ÈÈd l
(
ÈÈl m
provider
ÈÈm u
.
ÈÈu v#
AuthenticationSchemeÈÈv ä
)ÈÈä ã
)ÈÈã å
.ÈÈå ç
ToListÈÈç ì
(ÈÈì î
)ÈÈî ï
;ÈÈï ñ
}
ÍÍ 
}
ÎÎ 
}
ÏÏ 
return
ÓÓ 
new
ÓÓ 
RegisterViewModel
ÓÓ (
{
ÔÔ  
AllowRememberLogin
 "
=
# $
AccountOptions
% 3
.
3 4 
AllowRememberLogin
4 F
,
F G
EnableLocalLogin
ÒÒ  
=
ÒÒ! "

allowLocal
ÒÒ# -
&&
ÒÒ. 0
AccountOptions
ÒÒ1 ?
.
ÒÒ? @
AllowLocalLogin
ÒÒ@ O
,
ÒÒO P
	ReturnUrl
ÚÚ 
=
ÚÚ 
	returnUrl
ÚÚ %
,
ÚÚ% &
Username
ÛÛ 
=
ÛÛ 
context
ÛÛ "
?
ÛÛ" #
.
ÛÛ# $
	LoginHint
ÛÛ$ -
,
ÛÛ- .
ExternalProviders
ÙÙ !
=
ÙÙ" #
	providers
ÙÙ$ -
.
ÙÙ- .
ToArray
ÙÙ. 5
(
ÙÙ5 6
)
ÙÙ6 7
}
ıı 
;
ıı 
}
ˆˆ 	
private
˚˚ 
async
˚˚ 
Task
˚˚ 
<
˚˚ 
LoginViewModel
˚˚ )
>
˚˚) *&
BuildLoginViewModelAsync
˚˚+ C
(
˚˚C D
string
˚˚D J
	returnUrl
˚˚K T
)
˚˚T U
{
¸¸ 	
var
˝˝ 
context
˝˝ 
=
˝˝ 
await
˝˝ 
_interaction
˝˝  ,
.
˝˝, -*
GetAuthorizationContextAsync
˝˝- I
(
˝˝I J
	returnUrl
˝˝J S
)
˝˝S T
;
˝˝T U
if
˛˛ 
(
˛˛ 
context
˛˛ 
?
˛˛ 
.
˛˛ 
IdP
˛˛ 
!=
˛˛ 
null
˛˛  $
&&
˛˛% '
await
˛˛( -
_schemeProvider
˛˛. =
.
˛˛= >
GetSchemeAsync
˛˛> L
(
˛˛L M
context
˛˛M T
.
˛˛T U
IdP
˛˛U X
)
˛˛X Y
!=
˛˛Z \
null
˛˛] a
)
˛˛a b
{
ˇˇ 
var
ÄÄ 
local
ÄÄ 
=
ÄÄ 
context
ÄÄ #
.
ÄÄ# $
IdP
ÄÄ$ '
==
ÄÄ( *
Duende
ÄÄ+ 1
.
ÄÄ1 2
IdentityServer
ÄÄ2 @
.
ÄÄ@ A%
IdentityServerConstants
ÄÄA X
.
ÄÄX Y#
LocalIdentityProvider
ÄÄY n
;
ÄÄn o
var
ÉÉ 
vm
ÉÉ 
=
ÉÉ 
new
ÉÉ 
LoginViewModel
ÉÉ +
{
ÑÑ 
EnableLocalLogin
ÖÖ $
=
ÖÖ% &
local
ÖÖ' ,
,
ÖÖ, -
	ReturnUrl
ÜÜ 
=
ÜÜ 
	returnUrl
ÜÜ  )
,
ÜÜ) *
Username
áá 
=
áá 
context
áá &
?
áá& '
.
áá' (
	LoginHint
áá( 1
,
áá1 2
}
àà 
;
àà 
if
ää 
(
ää 
!
ää 
local
ää 
)
ää 
{
ãã 
vm
åå 
.
åå 
ExternalProviders
åå (
=
åå) *
new
åå+ .
[
åå. /
]
åå/ 0
{
åå1 2
new
åå3 6
ExternalProvider
åå7 G
{
ååH I"
AuthenticationScheme
ååJ ^
=
åå_ `
context
ååa h
.
ååh i
IdP
ååi l
}
ååm n
}
ååo p
;
ååp q
}
çç 
return
èè 
vm
èè 
;
èè 
}
êê 
var
íí 
schemes
íí 
=
íí 
await
íí 
_schemeProvider
íí  /
.
íí/ 0 
GetAllSchemesAsync
íí0 B
(
ííB C
)
ííC D
;
ííD E
var
îî 
	providers
îî 
=
îî 
schemes
îî #
.
ïï 
Where
ïï 
(
ïï 
x
ïï 
=>
ïï 
x
ïï 
.
ïï 
DisplayName
ïï )
!=
ïï* ,
null
ïï- 1
)
ïï1 2
.
ññ 
Select
ññ 
(
ññ 
x
ññ 
=>
ññ 
new
ññ  
ExternalProvider
ññ! 1
{
óó 
DisplayName
òò 
=
òò  !
x
òò" #
.
òò# $
DisplayName
òò$ /
??
òò0 2
x
òò3 4
.
òò4 5
Name
òò5 9
,
òò9 :"
AuthenticationScheme
ôô (
=
ôô) *
x
ôô+ ,
.
ôô, -
Name
ôô- 1
}
öö 
)
öö 
.
öö 
ToList
öö 
(
öö 
)
öö 
;
öö 
var
úú 
dyanmicSchemes
úú 
=
úú  
(
úú! "
await
úú" '$
_identityProviderStore
úú( >
.
úú> ?$
GetAllSchemeNamesAsync
úú? U
(
úúU V
)
úúV W
)
úúW X
.
ùù 
Where
ùù 
(
ùù 
x
ùù 
=>
ùù 
x
ùù 
.
ùù 
Enabled
ùù %
)
ùù% &
.
ûû 
Select
ûû 
(
ûû 
x
ûû 
=>
ûû 
new
ûû  
ExternalProvider
ûû! 1
{
üü "
AuthenticationScheme
†† (
=
††) *
x
††+ ,
.
††, -
Scheme
††- 3
,
††3 4
DisplayName
°° 
=
°°  !
x
°°" #
.
°°# $
DisplayName
°°$ /
}
¢¢ 
)
¢¢ 
;
¢¢ 
	providers
££ 
.
££ 
AddRange
££ 
(
££ 
dyanmicSchemes
££ -
)
££- .
;
££. /
var
•• 

allowLocal
•• 
=
•• 
true
•• !
;
••! "
if
¶¶ 
(
¶¶ 
context
¶¶ 
?
¶¶ 
.
¶¶ 
Client
¶¶ 
.
¶¶  
ClientId
¶¶  (
!=
¶¶) +
null
¶¶, 0
)
¶¶0 1
{
ßß 
var
®® 
client
®® 
=
®® 
await
®® "
_clientStore
®®# /
.
®®/ 0(
FindEnabledClientByIdAsync
®®0 J
(
®®J K
context
®®K R
.
®®R S
Client
®®S Y
.
®®Y Z
ClientId
®®Z b
)
®®b c
;
®®c d
if
©© 
(
©© 
client
©© 
!=
©© 
null
©© "
)
©©" #
{
™™ 

allowLocal
´´ 
=
´´  
client
´´! '
.
´´' (
EnableLocalLogin
´´( 8
;
´´8 9
if
≠≠ 
(
≠≠ 
client
≠≠ 
.
≠≠ *
IdentityProviderRestrictions
≠≠ ;
!=
≠≠< >
null
≠≠? C
&&
≠≠D F
client
≠≠G M
.
≠≠M N*
IdentityProviderRestrictions
≠≠N j
.
≠≠j k
Any
≠≠k n
(
≠≠n o
)
≠≠o p
)
≠≠p q
{
ÆÆ 
	providers
ØØ !
=
ØØ" #
	providers
ØØ$ -
.
ØØ- .
Where
ØØ. 3
(
ØØ3 4
provider
ØØ4 <
=>
ØØ= ?
client
ØØ@ F
.
ØØF G*
IdentityProviderRestrictions
ØØG c
.
ØØc d
Contains
ØØd l
(
ØØl m
provider
ØØm u
.
ØØu v#
AuthenticationSchemeØØv ä
)ØØä ã
)ØØã å
.ØØå ç
ToListØØç ì
(ØØì î
)ØØî ï
;ØØï ñ
}
∞∞ 
}
±± 
}
≤≤ 
return
¥¥ 
new
¥¥ 
LoginViewModel
¥¥ %
{
µµ  
AllowRememberLogin
∂∂ "
=
∂∂# $
AccountOptions
∂∂% 3
.
∂∂3 4 
AllowRememberLogin
∂∂4 F
,
∂∂F G
EnableLocalLogin
∑∑  
=
∑∑! "

allowLocal
∑∑# -
&&
∑∑. 0
AccountOptions
∑∑1 ?
.
∑∑? @
AllowLocalLogin
∑∑@ O
,
∑∑O P
	ReturnUrl
∏∏ 
=
∏∏ 
	returnUrl
∏∏ %
,
∏∏% &
Username
ππ 
=
ππ 
context
ππ "
?
ππ" #
.
ππ# $
	LoginHint
ππ$ -
,
ππ- .
ExternalProviders
∫∫ !
=
∫∫" #
	providers
∫∫$ -
.
∫∫- .
ToArray
∫∫. 5
(
∫∫5 6
)
∫∫6 7
}
ªª 
;
ªª 
}
ºº 	
private
ææ 
async
ææ 
Task
ææ 
<
ææ 
LoginViewModel
ææ )
>
ææ) *&
BuildLoginViewModelAsync
ææ+ C
(
ææC D
LoginInputModel
ææD S
model
ææT Y
)
ææY Z
{
øø 	
var
¿¿ 
vm
¿¿ 
=
¿¿ 
await
¿¿ &
BuildLoginViewModelAsync
¿¿ 3
(
¿¿3 4
model
¿¿4 9
.
¿¿9 :
	ReturnUrl
¿¿: C
)
¿¿C D
;
¿¿D E
vm
¡¡ 
.
¡¡ 
Username
¡¡ 
=
¡¡ 
model
¡¡ 
.
¡¡  
Username
¡¡  (
;
¡¡( )
vm
¬¬ 
.
¬¬ 
RememberLogin
¬¬ 
=
¬¬ 
model
¬¬ $
.
¬¬$ %
RememberLogin
¬¬% 2
;
¬¬2 3
return
√√ 
vm
√√ 
;
√√ 
}
ƒƒ 	
private
∆∆ 
async
∆∆ 
Task
∆∆ 
<
∆∆ 
LogoutViewModel
∆∆ *
>
∆∆* +'
BuildLogoutViewModelAsync
∆∆, E
(
∆∆E F
string
∆∆F L
logoutId
∆∆M U
)
∆∆U V
{
«« 	
var
»» 
vm
»» 
=
»» 
new
»» 
LogoutViewModel
»» (
{
»») *
LogoutId
»»+ 3
=
»»4 5
logoutId
»»6 >
,
»»> ?
ShowLogoutPrompt
»»@ P
=
»»Q R
AccountOptions
»»S a
.
»»a b
ShowLogoutPrompt
»»b r
}
»»s t
;
»»t u
if
   
(
   
User
   
?
   
.
   
Identity
   
.
   
IsAuthenticated
   .
!=
  / 1
true
  2 6
)
  6 7
{
ÀÀ 
vm
ÕÕ 
.
ÕÕ 
ShowLogoutPrompt
ÕÕ #
=
ÕÕ$ %
false
ÕÕ& +
;
ÕÕ+ ,
return
ŒŒ 
vm
ŒŒ 
;
ŒŒ 
}
œœ 
var
—— 
context
—— 
=
—— 
await
—— 
_interaction
——  ,
.
——, -#
GetLogoutContextAsync
——- B
(
——B C
logoutId
——C K
)
——K L
;
——L M
if
““ 
(
““ 
context
““ 
?
““ 
.
““ 
ShowSignoutPrompt
““ *
==
““+ -
false
““. 3
)
““3 4
{
”” 
vm
’’ 
.
’’ 
ShowLogoutPrompt
’’ #
=
’’$ %
false
’’& +
;
’’+ ,
return
÷÷ 
vm
÷÷ 
;
÷÷ 
}
◊◊ 
return
€€ 
vm
€€ 
;
€€ 
}
‹‹ 	
private
ﬁﬁ 
async
ﬁﬁ 
Task
ﬁﬁ 
<
ﬁﬁ  
LoggedOutViewModel
ﬁﬁ -
>
ﬁﬁ- .*
BuildLoggedOutViewModelAsync
ﬁﬁ/ K
(
ﬁﬁK L
string
ﬁﬁL R
logoutId
ﬁﬁS [
)
ﬁﬁ[ \
{
ﬂﬂ 	
var
·· 
logout
·· 
=
·· 
await
·· 
_interaction
·· +
.
··+ ,#
GetLogoutContextAsync
··, A
(
··A B
logoutId
··B J
)
··J K
;
··K L
var
„„ 
vm
„„ 
=
„„ 
new
„„  
LoggedOutViewModel
„„ +
{
‰‰ +
AutomaticRedirectAfterSignOut
ÂÂ -
=
ÂÂ. /
AccountOptions
ÂÂ0 >
.
ÂÂ> ?+
AutomaticRedirectAfterSignOut
ÂÂ? \
,
ÂÂ\ ]#
PostLogoutRedirectUri
ÊÊ %
=
ÊÊ& '
logout
ÊÊ( .
?
ÊÊ. /
.
ÊÊ/ 0#
PostLogoutRedirectUri
ÊÊ0 E
,
ÊÊE F

ClientName
ÁÁ 
=
ÁÁ 
string
ÁÁ #
.
ÁÁ# $
IsNullOrEmpty
ÁÁ$ 1
(
ÁÁ1 2
logout
ÁÁ2 8
?
ÁÁ8 9
.
ÁÁ9 :

ClientName
ÁÁ: D
)
ÁÁD E
?
ÁÁF G
logout
ÁÁH N
?
ÁÁN O
.
ÁÁO P
ClientId
ÁÁP X
:
ÁÁY Z
logout
ÁÁ[ a
?
ÁÁa b
.
ÁÁb c

ClientName
ÁÁc m
,
ÁÁm n
SignOutIframeUrl
ËË  
=
ËË! "
logout
ËË# )
?
ËË) *
.
ËË* +
SignOutIFrameUrl
ËË+ ;
,
ËË; <
LogoutId
ÈÈ 
=
ÈÈ 
logoutId
ÈÈ #
}
ÍÍ 
;
ÍÍ 
if
ÏÏ 
(
ÏÏ 
User
ÏÏ 
?
ÏÏ 
.
ÏÏ 
Identity
ÏÏ 
.
ÏÏ 
IsAuthenticated
ÏÏ .
==
ÏÏ/ 1
true
ÏÏ2 6
)
ÏÏ6 7
{
ÌÌ 
var
ÓÓ 
idp
ÓÓ 
=
ÓÓ 
User
ÓÓ 
.
ÓÓ 
	FindFirst
ÓÓ (
(
ÓÓ( )
JwtClaimTypes
ÓÓ) 6
.
ÓÓ6 7
IdentityProvider
ÓÓ7 G
)
ÓÓG H
?
ÓÓH I
.
ÓÓI J
Value
ÓÓJ O
;
ÓÓO P
if
ÔÔ 
(
ÔÔ 
idp
ÔÔ 
!=
ÔÔ 
null
ÔÔ 
&&
ÔÔ  "
idp
ÔÔ# &
!=
ÔÔ' )
Duende
ÔÔ* 0
.
ÔÔ0 1
IdentityServer
ÔÔ1 ?
.
ÔÔ? @%
IdentityServerConstants
ÔÔ@ W
.
ÔÔW X#
LocalIdentityProvider
ÔÔX m
)
ÔÔm n
{
 
var
ÒÒ %
providerSupportsSignout
ÒÒ /
=
ÒÒ0 1
await
ÒÒ2 7
HttpContext
ÒÒ8 C
.
ÒÒC D+
GetSchemeSupportsSignOutAsync
ÒÒD a
(
ÒÒa b
idp
ÒÒb e
)
ÒÒe f
;
ÒÒf g
if
ÚÚ 
(
ÚÚ %
providerSupportsSignout
ÚÚ /
)
ÚÚ/ 0
{
ÛÛ 
if
ÙÙ 
(
ÙÙ 
vm
ÙÙ 
.
ÙÙ 
LogoutId
ÙÙ '
==
ÙÙ( *
null
ÙÙ+ /
)
ÙÙ/ 0
{
ıı 
vm
˘˘ 
.
˘˘ 
LogoutId
˘˘ '
=
˘˘( )
await
˘˘* /
_interaction
˘˘0 <
.
˘˘< =&
CreateLogoutContextAsync
˘˘= U
(
˘˘U V
)
˘˘V W
;
˘˘W X
}
˙˙ 
vm
¸¸ 
.
¸¸ *
ExternalAuthenticationScheme
¸¸ 7
=
¸¸8 9
idp
¸¸: =
;
¸¸= >
}
˝˝ 
}
˛˛ 
}
ˇˇ 
return
ÅÅ 
vm
ÅÅ 
;
ÅÅ 
}
ÇÇ 	
}
ÉÉ 
}ÑÑ å

a/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/AccountOptions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
AccountOptions		 
{

 
public 
static 
bool 
AllowLocalLogin *
=+ ,
true- 1
;1 2
public 
static 
bool 
AllowRememberLogin -
=. /
true0 4
;4 5
public 
static 
TimeSpan #
RememberMeLoginDuration 6
=7 8
TimeSpan9 A
.A B
FromDaysB J
(J K
$numK M
)M N
;N O
public 
static 
bool 
ShowLogoutPrompt +
=, -
true. 2
;2 3
public 
static 
bool )
AutomaticRedirectAfterSignOut 8
=9 :
false; @
;@ A
public 
static 
string *
InvalidCredentialsErrorMessage ;
=< =
$str> \
;\ ]
} 
} ∑u
e/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/ExternalController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
ExternalController #
:$ %

Controller& 0
{ 
private 
readonly 
TestUserStore &
_users' -
;- .
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IClientStore %
_clientStore& 2
;2 3
private 
readonly 
ILogger  
<  !
ExternalController! 3
>3 4
_logger5 <
;< =
private   
readonly   
IEventService   &
_events  ' .
;  . /
public"" 
ExternalController"" !
(""! "-
!IIdentityServerInteractionService## -
interaction##. 9
,##9 :
IClientStore$$ 
clientStore$$ $
,$$$ %
IEventService%% 
events%%  
,%%  !
ILogger&& 
<&& 
ExternalController&& &
>&&& '
logger&&( .
,&&. /
TestUserStore'' 
users'' 
=''  !
null''" &
)''& '
{(( 	
_users** 
=** 
users** 
??** 
throw** #
new**$ '
	Exception**( 1
(**1 2
$str	**2 ¿
)
**¿ ¡
;
**¡ ¬
_interaction,, 
=,, 
interaction,, &
;,,& '
_clientStore-- 
=-- 
clientStore-- &
;--& '
_logger.. 
=.. 
logger.. 
;.. 
_events// 
=// 
events// 
;// 
}00 	
[55 	
HttpGet55	 
]55 
public66 
IActionResult66 
	Challenge66 &
(66& '
string66' -
scheme66. 4
,664 5
string666 <
	returnUrl66= F
)66F G
{77 	
if88 
(88 
string88 
.88 
IsNullOrEmpty88 $
(88$ %
	returnUrl88% .
)88. /
)88/ 0
	returnUrl881 :
=88; <
$str88= A
;88A B
if;; 
(;; 
Url;; 
.;; 

IsLocalUrl;; 
(;; 
	returnUrl;; (
);;( )
==;;* ,
false;;- 2
&&;;3 5
_interaction;;6 B
.;;B C
IsValidReturnUrl;;C S
(;;S T
	returnUrl;;T ]
);;] ^
==;;_ a
false;;b g
);;g h
{<< 
throw>> 
new>> 
	Exception>> #
(>># $
$str>>$ 8
)>>8 9
;>>9 :
}?? 
varBB 
propsBB 
=BB 
newBB $
AuthenticationPropertiesBB 4
{CC 
RedirectUriDD 
=DD 
UrlDD !
.DD! "
ActionDD" (
(DD( )
nameofDD) /
(DD/ 0
CallbackDD0 8
)DD8 9
)DD9 :
,DD: ;
ItemsEE 
=EE 
{FF 
{GG 
$strGG !
,GG! "
	returnUrlGG# ,
}GG- .
,GG. /
{HH 
$strHH 
,HH 
schemeHH  &
}HH' (
,HH( )
}II 
}JJ 
;JJ 
returnLL 
	ChallengeLL 
(LL 
propsLL "
,LL" #
schemeLL$ *
)LL* +
;LL+ ,
}MM 	
[RR 	
HttpGetRR	 
]RR 
publicSS 
asyncSS 
TaskSS 
<SS 
IActionResultSS '
>SS' (
CallbackSS) 1
(SS1 2
)SS2 3
{TT 	
varVV 
resultVV 
=VV 
awaitVV 
HttpContextVV *
.VV* +
AuthenticateAsyncVV+ <
(VV< =#
IdentityServerConstantsVV= T
.VVT U.
"ExternalCookieAuthenticationSchemeVVU w
)VVw x
;VVx y
ifWW 
(WW 
resultWW 
?WW 
.WW 
	SucceededWW !
!=WW" $
trueWW% )
)WW) *
{XX 
throwYY 
newYY 
	ExceptionYY #
(YY# $
$strYY$ C
)YYC D
;YYD E
}ZZ 
if\\ 
(\\ 
_logger\\ 
.\\ 
	IsEnabled\\ !
(\\! "
LogLevel\\" *
.\\* +
Debug\\+ 0
)\\0 1
)\\1 2
{]] 
var^^ 
externalClaims^^ "
=^^# $
result^^% +
.^^+ ,
	Principal^^, 5
.^^5 6
Claims^^6 <
.^^< =
Select^^= C
(^^C D
c^^D E
=>^^F H
$"^^I K
{^^K L
c^^L M
.^^M N
Type^^N R
}^^R S
$str^^S U
{^^U V
c^^V W
.^^W X
Value^^X ]
}^^] ^
"^^^ _
)^^_ `
;^^` a
_logger__ 
.__ 
LogDebug__  
(__  !
$str__! =
,__= >
externalClaims__? M
)__M N
;__N O
}`` 
varcc 
(cc 
usercc 
,cc 
providercc 
,cc  
providerUserIdcc! /
,cc/ 0
claimscc1 7
)cc7 8
=cc9 :(
FindUserFromExternalProvidercc; W
(ccW X
resultccX ^
)cc^ _
;cc_ `
ifdd 
(dd 
userdd 
==dd 
nulldd 
)dd 
{ee 
userii 
=ii 
AutoProvisionUserii (
(ii( )
providerii) 1
,ii1 2
providerUserIdii3 A
,iiA B
claimsiiC I
)iiI J
;iiJ K
}jj 
varoo !
additionalLocalClaimsoo %
=oo& '
newoo( +
Listoo, 0
<oo0 1
Claimoo1 6
>oo6 7
(oo7 8
)oo8 9
;oo9 :
varpp 
localSignInPropspp  
=pp! "
newpp# &$
AuthenticationPropertiespp' ?
(pp? @
)pp@ A
;ppA B 
ProcessLoginCallbackqq  
(qq  !
resultqq! '
,qq' (!
additionalLocalClaimsqq) >
,qq> ?
localSignInPropsqq@ P
)qqP Q
;qqQ R
vartt 
isusertt 
=tt 
newtt 
IdentityServerUsertt /
(tt/ 0
usertt0 4
.tt4 5
	SubjectIdtt5 >
)tt> ?
{uu 
DisplayNamevv 
=vv 
uservv "
.vv" #
Usernamevv# +
,vv+ ,
IdentityProviderww  
=ww! "
providerww# +
,ww+ ,
AdditionalClaimsxx  
=xx! "!
additionalLocalClaimsxx# 8
}yy 
;yy 
await{{ 
HttpContext{{ 
.{{ 
SignInAsync{{ )
({{) *
isuser{{* 0
,{{0 1
localSignInProps{{2 B
){{B C
;{{C D
await~~ 
HttpContext~~ 
.~~ 
SignOutAsync~~ *
(~~* +#
IdentityServerConstants~~+ B
.~~B C.
"ExternalCookieAuthenticationScheme~~C e
)~~e f
;~~f g
var
ÅÅ 
	returnUrl
ÅÅ 
=
ÅÅ 
result
ÅÅ "
.
ÅÅ" #

Properties
ÅÅ# -
.
ÅÅ- .
Items
ÅÅ. 3
[
ÅÅ3 4
$str
ÅÅ4 ?
]
ÅÅ? @
??
ÅÅA C
$str
ÅÅD H
;
ÅÅH I
var
ÑÑ 
context
ÑÑ 
=
ÑÑ 
await
ÑÑ 
_interaction
ÑÑ  ,
.
ÑÑ, -*
GetAuthorizationContextAsync
ÑÑ- I
(
ÑÑI J
	returnUrl
ÑÑJ S
)
ÑÑS T
;
ÑÑT U
await
ÖÖ 
_events
ÖÖ 
.
ÖÖ 

RaiseAsync
ÖÖ $
(
ÖÖ$ %
new
ÖÖ% (#
UserLoginSuccessEvent
ÖÖ) >
(
ÖÖ> ?
provider
ÖÖ? G
,
ÖÖG H
providerUserId
ÖÖI W
,
ÖÖW X
user
ÖÖY ]
.
ÖÖ] ^
	SubjectId
ÖÖ^ g
,
ÖÖg h
user
ÖÖi m
.
ÖÖm n
Username
ÖÖn v
,
ÖÖv w
true
ÖÖx |
,
ÖÖ| }
contextÖÖ~ Ö
?ÖÖÖ Ü
.ÖÖÜ á
ClientÖÖá ç
.ÖÖç é
ClientIdÖÖé ñ
)ÖÖñ ó
)ÖÖó ò
;ÖÖò ô
if
áá 
(
áá 
context
áá 
!=
áá 
null
áá 
)
áá  
{
àà 
if
ââ 
(
ââ 
context
ââ 
.
ââ 
IsNativeClient
ââ *
(
ââ* +
)
ââ+ ,
)
ââ, -
{
ää 
return
çç 
this
çç 
.
çç  
LoadingPage
çç  +
(
çç+ ,
$str
çç, 6
,
çç6 7
	returnUrl
çç8 A
)
ççA B
;
ççB C
}
éé 
}
èè 
return
ëë 
Redirect
ëë 
(
ëë 
	returnUrl
ëë %
)
ëë% &
;
ëë& '
}
íí 	
private
îî 
(
îî 
TestUser
îî 
user
îî 
,
îî 
string
îî  &
provider
îî' /
,
îî/ 0
string
îî1 7
providerUserId
îî8 F
,
îîF G
IEnumerable
îîH S
<
îîS T
Claim
îîT Y
>
îîY Z
claims
îî[ a
)
îîa b*
FindUserFromExternalProvider
îîc 
(îî Ä"
AuthenticateResultîîÄ í
resultîîì ô
)îîô ö
{
ïï 	
var
ññ 
externalUser
ññ 
=
ññ 
result
ññ %
.
ññ% &
	Principal
ññ& /
;
ññ/ 0
var
õõ 
userIdClaim
õõ 
=
õõ 
externalUser
õõ *
.
õõ* +
	FindFirst
õõ+ 4
(
õõ4 5
JwtClaimTypes
õõ5 B
.
õõB C
Subject
õõC J
)
õõJ K
??
õõL N
externalUser
úú *
.
úú* +
	FindFirst
úú+ 4
(
úú4 5

ClaimTypes
úú5 ?
.
úú? @
NameIdentifier
úú@ N
)
úúN O
??
úúP R
throw
ùù #
new
ùù$ '
	Exception
ùù( 1
(
ùù1 2
$str
ùù2 B
)
ùùB C
;
ùùC D
var
†† 
claims
†† 
=
†† 
externalUser
†† %
.
††% &
Claims
††& ,
.
††, -
ToList
††- 3
(
††3 4
)
††4 5
;
††5 6
claims
°° 
.
°° 
Remove
°° 
(
°° 
userIdClaim
°° %
)
°°% &
;
°°& '
var
££ 
provider
££ 
=
££ 
result
££ !
.
££! "

Properties
££" ,
.
££, -
Items
££- 2
[
££2 3
$str
££3 ;
]
££; <
;
££< =
var
§§ 
providerUserId
§§ 
=
§§  
userIdClaim
§§! ,
.
§§, -
Value
§§- 2
;
§§2 3
var
ßß 
user
ßß 
=
ßß 
_users
ßß 
.
ßß $
FindByExternalProvider
ßß 4
(
ßß4 5
provider
ßß5 =
,
ßß= >
providerUserId
ßß? M
)
ßßM N
;
ßßN O
return
©© 
(
©© 
user
©© 
,
©© 
provider
©© "
,
©©" #
providerUserId
©©$ 2
,
©©2 3
claims
©©4 :
)
©©: ;
;
©©; <
}
™™ 	
private
¨¨ 
TestUser
¨¨ 
AutoProvisionUser
¨¨ *
(
¨¨* +
string
¨¨+ 1
provider
¨¨2 :
,
¨¨: ;
string
¨¨< B
providerUserId
¨¨C Q
,
¨¨Q R
IEnumerable
¨¨S ^
<
¨¨^ _
Claim
¨¨_ d
>
¨¨d e
claims
¨¨f l
)
¨¨l m
{
≠≠ 	
var
ÆÆ 
user
ÆÆ 
=
ÆÆ 
_users
ÆÆ 
.
ÆÆ 
AutoProvisionUser
ÆÆ /
(
ÆÆ/ 0
provider
ÆÆ0 8
,
ÆÆ8 9
providerUserId
ÆÆ: H
,
ÆÆH I
claims
ÆÆJ P
.
ÆÆP Q
ToList
ÆÆQ W
(
ÆÆW X
)
ÆÆX Y
)
ÆÆY Z
;
ÆÆZ [
return
ØØ 
user
ØØ 
;
ØØ 
}
∞∞ 	
private
¥¥ 
void
¥¥ "
ProcessLoginCallback
¥¥ )
(
¥¥) * 
AuthenticateResult
¥¥* <
externalResult
¥¥= K
,
¥¥K L
List
¥¥M Q
<
¥¥Q R
Claim
¥¥R W
>
¥¥W X
localClaims
¥¥Y d
,
¥¥d e&
AuthenticationProperties
¥¥f ~
localSignInProps¥¥ è
)¥¥è ê
{
µµ 	
var
∏∏ 
sid
∏∏ 
=
∏∏ 
externalResult
∏∏ $
.
∏∏$ %
	Principal
∏∏% .
.
∏∏. /
Claims
∏∏/ 5
.
∏∏5 6
FirstOrDefault
∏∏6 D
(
∏∏D E
x
∏∏E F
=>
∏∏G I
x
∏∏J K
.
∏∏K L
Type
∏∏L P
==
∏∏Q S
JwtClaimTypes
∏∏T a
.
∏∏a b
	SessionId
∏∏b k
)
∏∏k l
;
∏∏l m
if
ππ 
(
ππ 
sid
ππ 
!=
ππ 
null
ππ 
)
ππ 
{
∫∫ 
localClaims
ªª 
.
ªª 
Add
ªª 
(
ªª  
new
ªª  #
Claim
ªª$ )
(
ªª) *
JwtClaimTypes
ªª* 7
.
ªª7 8
	SessionId
ªª8 A
,
ªªA B
sid
ªªC F
.
ªªF G
Value
ªªG L
)
ªªL M
)
ªªM N
;
ªªN O
}
ºº 
var
øø 
idToken
øø 
=
øø 
externalResult
øø (
.
øø( )

Properties
øø) 3
.
øø3 4
GetTokenValue
øø4 A
(
øøA B
$str
øøB L
)
øøL M
;
øøM N
if
¿¿ 
(
¿¿ 
idToken
¿¿ 
!=
¿¿ 
null
¿¿ 
)
¿¿  
{
¡¡ 
localSignInProps
¬¬  
.
¬¬  !
StoreTokens
¬¬! ,
(
¬¬, -
new
¬¬- 0
[
¬¬0 1
]
¬¬1 2
{
¬¬3 4
new
¬¬5 8!
AuthenticationToken
¬¬9 L
{
¬¬M N
Name
¬¬O S
=
¬¬T U
$str
¬¬V `
,
¬¬` a
Value
¬¬b g
=
¬¬h i
idToken
¬¬j q
}
¬¬r s
}
¬¬t u
)
¬¬u v
;
¬¬v w
}
√√ 
}
ƒƒ 	
}
≈≈ 
}∆∆ §
c/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/ExternalProvider.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ExternalProvider !
{ 
public		 
string		 
DisplayName		 !
{		" #
get		$ '
;		' (
set		) ,
;		, -
}		. /
public

 
string

  
AuthenticationScheme

 *
{

+ ,
get

- 0
;

0 1
set

2 5
;

5 6
}

7 8
} 
} ¸
e/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/LoggedOutViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LoggedOutViewModel #
{ 
public		 
string		 !
PostLogoutRedirectUri		 +
{		, -
get		. 1
;		1 2
set		3 6
;		6 7
}		8 9
public

 
string

 

ClientName

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 
string 
SignOutIframeUrl &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
bool )
AutomaticRedirectAfterSignOut 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
public 
string 
LogoutId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool "
TriggerExternalSignout *
=>+ -(
ExternalAuthenticationScheme. J
!=K M
nullN R
;R S
public 
string (
ExternalAuthenticationScheme 2
{3 4
get5 8
;8 9
set: =
;= >
}? @
} 
} ∑
b/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/LoginInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
LoginInputModel		  
{

 
[ 	
Required	 
] 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
Required	 
] 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
bool 
RememberLogin !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
string 
	ReturnUrl 
{  !
get" %
;% &
set' *
;* +
}, -
} 
} ·
a/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/LoginViewModel.cs
	namespace		 	
IdentityServerHost		
 
.		 

Quickstart		 '
.		' (
UI		( *
{

 
public 

class 
LoginViewModel 
:  !
LoginInputModel" 1
{ 
public 
bool 
AllowRememberLogin &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
=5 6
true7 ;
;; <
public 
bool 
EnableLocalLogin $
{% &
get' *
;* +
set, /
;/ 0
}1 2
=3 4
true5 9
;9 :
public 
IEnumerable 
< 
ExternalProvider +
>+ ,
ExternalProviders- >
{? @
getA D
;D E
setF I
;I J
}K L
=M N

EnumerableO Y
.Y Z
EmptyZ _
<_ `
ExternalProvider` p
>p q
(q r
)r s
;s t
public 
IEnumerable 
< 
ExternalProvider +
>+ ,$
VisibleExternalProviders- E
=>F H
ExternalProvidersI Z
.Z [
Where[ `
(` a
xa b
=>c e
!f g
Stringg m
.m n
IsNullOrWhiteSpace	n Ä
(
Ä Å
x
Å Ç
.
Ç É
DisplayName
É é
)
é è
)
è ê
;
ê ë
public 
bool 
IsExternalLoginOnly '
=>( *
EnableLocalLogin+ ;
==< >
false? D
&&E G
ExternalProvidersH Y
?Y Z
.Z [
Count[ `
(` a
)a b
==c e
$numf g
;g h
public 
string 
ExternalLoginScheme )
=>* ,
IsExternalLoginOnly- @
?A B
ExternalProvidersC T
?T U
.U V
SingleOrDefaultV e
(e f
)f g
?g h
.h i 
AuthenticationSchemei }
:~ 
null
Ä Ñ
;
Ñ Ö
} 
} ˘
c/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/LogoutInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LogoutInputModel !
{ 
public		 
string		 
LogoutId		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} ⁄
b/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/LogoutViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
LogoutViewModel  
:! "
LogoutInputModel# 3
{ 
public		 
bool		 
ShowLogoutPrompt		 $
{		% &
get		' *
;		* +
set		, /
;		/ 0
}		1 2
=		3 4
true		5 9
;		9 :
}

 
} ˛
d/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/RedirectViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
RedirectViewModel "
{		 
public

 
string

 
RedirectUrl

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
} 
} Ä
d/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Account/RegisterViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
;* +
public 
class 
RegisterViewModel 
{ 
[ 
Required 
] 
public 

string 
Username 
{ 
get  
;  !
set" %
;% &
}' (
[

 
Required

 
]

 
public 

string 
Email 
{ 
get 
; 
set "
;" #
}$ %
public 

string 
	FirstName 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
LastNAme 
{ 
get  
;  !
set" %
;% &
}' (
[ 
Required 
] 
public 

string 
Password 
{ 
get  
;  !
set" %
;% &
}' (
public 

string 
	ReturnUrl 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
RoleName 
{ 
get  
;  !
set" %
;% &
}' (
public 

bool 
AllowRememberLogin "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
true3 7
;7 8
public 

bool 
EnableLocalLogin  
{! "
get# &
;& '
set( +
;+ ,
}- .
=/ 0
true1 5
;5 6
public 

IEnumerable 
< 
ExternalProvider '
>' (
ExternalProviders) :
{; <
get= @
;@ A
setB E
;E F
}G H
=I J

EnumerableK U
.U V
EmptyV [
<[ \
ExternalProvider\ l
>l m
(m n
)n o
;o p
public 

IEnumerable 
< 
ExternalProvider '
>' ($
VisibleExternalProviders) A
=>B D
ExternalProvidersE V
.V W
WhereW \
(\ ]
x] ^
=>_ a
!b c
Stringc i
.i j
IsNullOrWhiteSpacej |
(| }
x} ~
.~ 
DisplayName	 ä
)
ä ã
)
ã å
;
å ç
public 

bool 
IsExternalLoginOnly #
=>$ &
EnableLocalLogin' 7
==8 :
false; @
&&A C
ExternalProvidersD U
?U V
.V W
CountW \
(\ ]
)] ^
==_ a
$numb c
;c d
public 

string 
ExternalLoginScheme %
=>& (
IsExternalLoginOnly) <
?= >
ExternalProviders? P
?P Q
.Q R
SingleOrDefaultR a
(a b
)b c
?c d
.d e 
AuthenticationSchemee y
:z {
null	| Ä
;
Ä Å
} Üº
d/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ConsentController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class 
ConsentController "
:# $

Controller% /
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IEventService &
_events' .
;. /
private 
readonly 
ILogger  
<  !
ConsentController! 2
>2 3
_logger4 ;
;; <
public   
ConsentController    
(    !-
!IIdentityServerInteractionService!! -
interaction!!. 9
,!!9 :
IEventService"" 
events""  
,""  !
ILogger## 
<## 
ConsentController## %
>##% &
logger##' -
)##- .
{$$ 	
_interaction%% 
=%% 
interaction%% &
;%%& '
_events&& 
=&& 
events&& 
;&& 
_logger'' 
='' 
logger'' 
;'' 
}(( 	
[// 	
HttpGet//	 
]// 
public00 
async00 
Task00 
<00 
IActionResult00 '
>00' (
Index00) .
(00. /
string00/ 5
	returnUrl006 ?
)00? @
{11 	
var22 
vm22 
=22 
await22 
BuildViewModelAsync22 .
(22. /
	returnUrl22/ 8
)228 9
;229 :
if33 
(33 
vm33 
!=33 
null33 
)33 
{44 
return55 
View55 
(55 
$str55 #
,55# $
vm55% '
)55' (
;55( )
}66 
return88 
View88 
(88 
$str88 
)88  
;88  !
}99 	
[>> 	
HttpPost>>	 
]>> 
[?? 	$
ValidateAntiForgeryToken??	 !
]??! "
public@@ 
async@@ 
Task@@ 
<@@ 
IActionResult@@ '
>@@' (
Index@@) .
(@@. /
ConsentInputModel@@/ @
model@@A F
)@@F G
{AA 	
varBB 
resultBB 
=BB 
awaitBB 
ProcessConsentBB -
(BB- .
modelBB. 3
)BB3 4
;BB4 5
ifDD 
(DD 
resultDD 
.DD 

IsRedirectDD !
)DD! "
{EE 
varFF 
contextFF 
=FF 
awaitFF #
_interactionFF$ 0
.FF0 1(
GetAuthorizationContextAsyncFF1 M
(FFM N
modelFFN S
.FFS T
	ReturnUrlFFT ]
)FF] ^
;FF^ _
ifGG 
(GG 
contextGG 
?GG 
.GG 
IsNativeClientGG +
(GG+ ,
)GG, -
==GG. 0
trueGG1 5
)GG5 6
{HH 
returnKK 
thisKK 
.KK  
LoadingPageKK  +
(KK+ ,
$strKK, 6
,KK6 7
resultKK8 >
.KK> ?
RedirectUriKK? J
)KKJ K
;KKK L
}LL 
returnNN 
RedirectNN 
(NN  
resultNN  &
.NN& '
RedirectUriNN' 2
)NN2 3
;NN3 4
}OO 
ifQQ 
(QQ 
resultQQ 
.QQ 
HasValidationErrorQQ )
)QQ) *
{RR 

ModelStateSS 
.SS 
AddModelErrorSS (
(SS( )
stringSS) /
.SS/ 0
EmptySS0 5
,SS5 6
resultSS7 =
.SS= >
ValidationErrorSS> M
)SSM N
;SSN O
}TT 
ifVV 
(VV 
resultVV 
.VV 
ShowViewVV 
)VV  
{WW 
returnXX 
ViewXX 
(XX 
$strXX #
,XX# $
resultXX% +
.XX+ ,
	ViewModelXX, 5
)XX5 6
;XX6 7
}YY 
return[[ 
View[[ 
([[ 
$str[[ 
)[[  
;[[  !
}\\ 	
privateaa 
asyncaa 
Taskaa 
<aa  
ProcessConsentResultaa /
>aa/ 0
ProcessConsentaa1 ?
(aa? @
ConsentInputModelaa@ Q
modelaaR W
)aaW X
{bb 	
varcc 
resultcc 
=cc 
newcc  
ProcessConsentResultcc 1
(cc1 2
)cc2 3
;cc3 4
varff 
requestff 
=ff 
awaitff 
_interactionff  ,
.ff, -(
GetAuthorizationContextAsyncff- I
(ffI J
modelffJ O
.ffO P
	ReturnUrlffP Y
)ffY Z
;ffZ [
ifgg 
(gg 
requestgg 
==gg 
nullgg 
)gg  
returngg! '
resultgg( .
;gg. /
ConsentResponseii 
grantedConsentii *
=ii+ ,
nullii- 1
;ii1 2
ifll 
(ll 
modelll 
?ll 
.ll 
Buttonll 
==ll  
$strll! %
)ll% &
{mm 
grantedConsentnn 
=nn  
newnn! $
ConsentResponsenn% 4
{nn5 6
Errornn7 <
=nn= >
AuthorizationErrornn? Q
.nnQ R
AccessDeniednnR ^
}nn_ `
;nn` a
awaitqq 
_eventsqq 
.qq 

RaiseAsyncqq (
(qq( )
newqq) ,
ConsentDeniedEventqq- ?
(qq? @
Userqq@ D
.qqD E
GetSubjectIdqqE Q
(qqQ R
)qqR S
,qqS T
requestqqU \
.qq\ ]
Clientqq] c
.qqc d
ClientIdqqd l
,qql m
requestqqn u
.qqu v
ValidatedResources	qqv à
.
qqà â
RawScopeValues
qqâ ó
)
qqó ò
)
qqò ô
;
qqô ö
}rr 
elsett 
iftt 
(tt 
modeltt 
?tt 
.tt 
Buttontt "
==tt# %
$strtt& +
)tt+ ,
{uu 
ifww 
(ww 
modelww 
.ww 
ScopesConsentedww )
!=ww* ,
nullww- 1
&&ww2 4
modelww5 :
.ww: ;
ScopesConsentedww; J
.wwJ K
AnywwK N
(wwN O
)wwO P
)wwP Q
{xx 
varyy 
scopesyy 
=yy  
modelyy! &
.yy& '
ScopesConsentedyy' 6
;yy6 7
ifzz 
(zz 
ConsentOptionszz &
.zz& '
EnableOfflineAccesszz' :
==zz; =
falsezz> C
)zzC D
{{{ 
scopes|| 
=||  
scopes||! '
.||' (
Where||( -
(||- .
x||. /
=>||0 2
x||3 4
!=||5 7
Duende||8 >
.||> ?
IdentityServer||? M
.||M N#
IdentityServerConstants||N e
.||e f
StandardScopes||f t
.||t u
OfflineAccess	||u Ç
)
||Ç É
;
||É Ñ
}}} 
grantedConsent "
=# $
new% (
ConsentResponse) 8
{
ÄÄ 
RememberConsent
ÅÅ '
=
ÅÅ( )
model
ÅÅ* /
.
ÅÅ/ 0
RememberConsent
ÅÅ0 ?
,
ÅÅ? @#
ScopesValuesConsented
ÇÇ -
=
ÇÇ. /
scopes
ÇÇ0 6
.
ÇÇ6 7
ToArray
ÇÇ7 >
(
ÇÇ> ?
)
ÇÇ? @
,
ÇÇ@ A
Description
ÉÉ #
=
ÉÉ$ %
model
ÉÉ& +
.
ÉÉ+ ,
Description
ÉÉ, 7
}
ÑÑ 
;
ÑÑ 
await
áá 
_events
áá !
.
áá! "

RaiseAsync
áá" ,
(
áá, -
new
áá- 0!
ConsentGrantedEvent
áá1 D
(
ááD E
User
ááE I
.
ááI J
GetSubjectId
ááJ V
(
ááV W
)
ááW X
,
ááX Y
request
ááZ a
.
ááa b
Client
ááb h
.
ááh i
ClientId
áái q
,
ááq r
request
áás z
.
ááz {!
ValidatedResourcesáá{ ç
.ááç é
RawScopeValuesááé ú
,ááú ù
grantedConsentááû ¨
.áá¨ ≠%
ScopesValuesConsentedáá≠ ¬
,áá¬ √
grantedConsentááƒ “
.áá“ ”
RememberConsentáá” ‚
)áá‚ „
)áá„ ‰
;áá‰ Â
}
àà 
else
ââ 
{
ää 
result
ãã 
.
ãã 
ValidationError
ãã *
=
ãã+ ,
ConsentOptions
ãã- ;
.
ãã; <'
MustChooseOneErrorMessage
ãã< U
;
ããU V
}
åå 
}
çç 
else
éé 
{
èè 
result
êê 
.
êê 
ValidationError
êê &
=
êê' (
ConsentOptions
êê) 7
.
êê7 8*
InvalidSelectionErrorMessage
êê8 T
;
êêT U
}
ëë 
if
ìì 
(
ìì 
grantedConsent
ìì 
!=
ìì !
null
ìì" &
)
ìì& '
{
îî 
await
ññ 
_interaction
ññ "
.
ññ" #
GrantConsentAsync
ññ# 4
(
ññ4 5
request
ññ5 <
,
ññ< =
grantedConsent
ññ> L
)
ññL M
;
ññM N
result
ôô 
.
ôô 
RedirectUri
ôô "
=
ôô# $
model
ôô% *
.
ôô* +
	ReturnUrl
ôô+ 4
;
ôô4 5
result
öö 
.
öö 
Client
öö 
=
öö 
request
öö  '
.
öö' (
Client
öö( .
;
öö. /
}
õõ 
else
úú 
{
ùù 
result
üü 
.
üü 
	ViewModel
üü  
=
üü! "
await
üü# (!
BuildViewModelAsync
üü) <
(
üü< =
model
üü= B
.
üüB C
	ReturnUrl
üüC L
,
üüL M
model
üüN S
)
üüS T
;
üüT U
}
†† 
return
¢¢ 
result
¢¢ 
;
¢¢ 
}
££ 	
private
•• 
async
•• 
Task
•• 
<
•• 
ConsentViewModel
•• +
>
••+ ,!
BuildViewModelAsync
••- @
(
••@ A
string
••A G
	returnUrl
••H Q
,
••Q R
ConsentInputModel
••S d
model
••e j
=
••k l
null
••m q
)
••q r
{
¶¶ 	
var
ßß 
request
ßß 
=
ßß 
await
ßß 
_interaction
ßß  ,
.
ßß, -*
GetAuthorizationContextAsync
ßß- I
(
ßßI J
	returnUrl
ßßJ S
)
ßßS T
;
ßßT U
if
®® 
(
®® 
request
®® 
!=
®® 
null
®® 
)
®®  
{
©© 
return
™™ $
CreateConsentViewModel
™™ -
(
™™- .
model
™™. 3
,
™™3 4
	returnUrl
™™5 >
,
™™> ?
request
™™@ G
)
™™G H
;
™™H I
}
´´ 
else
¨¨ 
{
≠≠ 
_logger
ÆÆ 
.
ÆÆ 
LogError
ÆÆ  
(
ÆÆ  !
$str
ÆÆ! K
,
ÆÆK L
	returnUrl
ÆÆM V
)
ÆÆV W
;
ÆÆW X
}
ØØ 
return
±± 
null
±± 
;
±± 
}
≤≤ 	
private
¥¥ 
ConsentViewModel
¥¥  $
CreateConsentViewModel
¥¥! 7
(
¥¥7 8
ConsentInputModel
µµ 
model
µµ #
,
µµ# $
string
µµ% +
	returnUrl
µµ, 5
,
µµ5 6"
AuthorizationRequest
∂∂  
request
∂∂! (
)
∂∂( )
{
∑∑ 	
var
∏∏ 
vm
∏∏ 
=
∏∏ 
new
∏∏ 
ConsentViewModel
∏∏ )
{
ππ 
RememberConsent
∫∫ 
=
∫∫  !
model
∫∫" '
?
∫∫' (
.
∫∫( )
RememberConsent
∫∫) 8
??
∫∫9 ;
true
∫∫< @
,
∫∫@ A
ScopesConsented
ªª 
=
ªª  !
model
ªª" '
?
ªª' (
.
ªª( )
ScopesConsented
ªª) 8
??
ªª9 ;

Enumerable
ªª< F
.
ªªF G
Empty
ªªG L
<
ªªL M
string
ªªM S
>
ªªS T
(
ªªT U
)
ªªU V
,
ªªV W
Description
ºº 
=
ºº 
model
ºº #
?
ºº# $
.
ºº$ %
Description
ºº% 0
,
ºº0 1
	ReturnUrl
ææ 
=
ææ 
	returnUrl
ææ %
,
ææ% &

ClientName
¿¿ 
=
¿¿ 
request
¿¿ $
.
¿¿$ %
Client
¿¿% +
.
¿¿+ ,

ClientName
¿¿, 6
??
¿¿7 9
request
¿¿: A
.
¿¿A B
Client
¿¿B H
.
¿¿H I
ClientId
¿¿I Q
,
¿¿Q R
	ClientUrl
¡¡ 
=
¡¡ 
request
¡¡ #
.
¡¡# $
Client
¡¡$ *
.
¡¡* +
	ClientUri
¡¡+ 4
,
¡¡4 5
ClientLogoUrl
¬¬ 
=
¬¬ 
request
¬¬  '
.
¬¬' (
Client
¬¬( .
.
¬¬. /
LogoUri
¬¬/ 6
,
¬¬6 7"
AllowRememberConsent
√√ $
=
√√% &
request
√√' .
.
√√. /
Client
√√/ 5
.
√√5 6"
AllowRememberConsent
√√6 J
}
ƒƒ 
;
ƒƒ 
vm
∆∆ 
.
∆∆ 
IdentityScopes
∆∆ 
=
∆∆ 
request
∆∆  '
.
∆∆' ( 
ValidatedResources
∆∆( :
.
∆∆: ;
	Resources
∆∆; D
.
∆∆D E
IdentityResources
∆∆E V
.
«« 
Select
«« 
(
«« 
x
«« 
=>
«« "
CreateScopeViewModel
«« 1
(
««1 2
x
««2 3
,
««3 4
vm
««5 7
.
««7 8
ScopesConsented
««8 G
.
««G H
Contains
««H P
(
««P Q
x
««Q R
.
««R S
Name
««S W
)
««W X
||
««Y [
model
««\ a
==
««b d
null
««e i
)
««i j
)
««j k
.
»» 
ToArray
»» 
(
»» 
)
»» 
;
»» 
var
    
resourceIndicators
   "
=
  # $
request
  % ,
.
  , -

Parameters
  - 7
.
  7 8
	GetValues
  8 A
(
  A B
OidcConstants
  B O
.
  O P
AuthorizeRequest
  P `
.
  ` a
Resource
  a i
)
  i j
??
  k m

Enumerable
  n x
.
  x y
Empty
  y ~
<
  ~ 
string   Ö
>  Ö Ü
(  Ü á
)  á à
;  à â
var
ÀÀ 
apiResources
ÀÀ 
=
ÀÀ 
request
ÀÀ &
.
ÀÀ& ' 
ValidatedResources
ÀÀ' 9
.
ÀÀ9 :
	Resources
ÀÀ: C
.
ÀÀC D
ApiResources
ÀÀD P
.
ÀÀP Q
Where
ÀÀQ V
(
ÀÀV W
x
ÀÀW X
=>
ÀÀY [ 
resourceIndicators
ÀÀ\ n
.
ÀÀn o
Contains
ÀÀo w
(
ÀÀw x
x
ÀÀx y
.
ÀÀy z
Name
ÀÀz ~
)
ÀÀ~ 
)ÀÀ Ä
;ÀÀÄ Å
var
ÕÕ 
	apiScopes
ÕÕ 
=
ÕÕ 
new
ÕÕ 
List
ÕÕ  $
<
ÕÕ$ %
ScopeViewModel
ÕÕ% 3
>
ÕÕ3 4
(
ÕÕ4 5
)
ÕÕ5 6
;
ÕÕ6 7
foreach
ŒŒ 
(
ŒŒ 
var
ŒŒ 
parsedScope
ŒŒ $
in
ŒŒ% '
request
ŒŒ( /
.
ŒŒ/ 0 
ValidatedResources
ŒŒ0 B
.
ŒŒB C
ParsedScopes
ŒŒC O
)
ŒŒO P
{
œœ 
var
–– 
apiScope
–– 
=
–– 
request
–– &
.
––& ' 
ValidatedResources
––' 9
.
––9 :
	Resources
––: C
.
––C D
FindApiScope
––D P
(
––P Q
parsedScope
––Q \
.
––\ ]

ParsedName
––] g
)
––g h
;
––h i
if
—— 
(
—— 
apiScope
—— 
!=
—— 
null
——  $
)
——$ %
{
““ 
var
”” 
scopeVm
”” 
=
””  !"
CreateScopeViewModel
””" 6
(
””6 7
parsedScope
””7 B
,
””B C
apiScope
””D L
,
””L M
vm
””N P
.
””P Q
ScopesConsented
””Q `
.
””` a
Contains
””a i
(
””i j
parsedScope
””j u
.
””u v
RawValue
””v ~
)
””~ 
||””Ä Ç
model””É à
==””â ã
null””å ê
)””ê ë
;””ë í
scopeVm
‘‘ 
.
‘‘ 
	Resources
‘‘ %
=
‘‘& '
apiResources
‘‘( 4
.
‘‘4 5
Where
‘‘5 :
(
‘‘: ;
x
‘‘; <
=>
‘‘= ?
x
‘‘@ A
.
‘‘A B
Scopes
‘‘B H
.
‘‘H I
Contains
‘‘I Q
(
‘‘Q R
parsedScope
‘‘R ]
.
‘‘] ^

ParsedName
‘‘^ h
)
‘‘h i
)
‘‘i j
.
’’ 
Select
’’ 
(
’’  
x
’’  !
=>
’’! #
new
’’$ '
ResourceViewModel
’’( 9
{
÷÷ 
Name
◊◊  
=
◊◊! "
x
◊◊# $
.
◊◊$ %
Name
◊◊% )
,
◊◊) *
DisplayName
ÿÿ '
=
ÿÿ( )
x
ÿÿ* +
.
ÿÿ+ ,
DisplayName
ÿÿ, 7
??
ÿÿ8 :
x
ÿÿ; <
.
ÿÿ< =
Name
ÿÿ= A
,
ÿÿA B
}
ŸŸ 
)
ŸŸ 
.
ŸŸ 
ToArray
ŸŸ "
(
ŸŸ" #
)
ŸŸ# $
;
ŸŸ$ %
	apiScopes
⁄⁄ 
.
⁄⁄ 
Add
⁄⁄ !
(
⁄⁄! "
scopeVm
⁄⁄" )
)
⁄⁄) *
;
⁄⁄* +
}
€€ 
}
‹‹ 
if
›› 
(
›› 
ConsentOptions
›› 
.
›› !
EnableOfflineAccess
›› 2
&&
››3 5
request
››6 =
.
››= > 
ValidatedResources
››> P
.
››P Q
	Resources
››Q Z
.
››Z [
OfflineAccess
››[ h
)
››h i
{
ﬁﬁ 
	apiScopes
ﬂﬂ 
.
ﬂﬂ 
Add
ﬂﬂ 
(
ﬂﬂ #
GetOfflineAccessScope
ﬂﬂ 3
(
ﬂﬂ3 4
vm
ﬂﬂ4 6
.
ﬂﬂ6 7
ScopesConsented
ﬂﬂ7 F
.
ﬂﬂF G
Contains
ﬂﬂG O
(
ﬂﬂO P
Duende
ﬂﬂP V
.
ﬂﬂV W
IdentityServer
ﬂﬂW e
.
ﬂﬂe f%
IdentityServerConstants
ﬂﬂf }
.
ﬂﬂ} ~
StandardScopesﬂﬂ~ å
.ﬂﬂå ç
OfflineAccessﬂﬂç ö
)ﬂﬂö õ
||ﬂﬂú û
modelﬂﬂü §
==ﬂﬂ• ß
nullﬂﬂ® ¨
)ﬂﬂ¨ ≠
)ﬂﬂ≠ Æ
;ﬂﬂÆ Ø
}
‡‡ 
vm
·· 
.
·· 
	ApiScopes
·· 
=
·· 
	apiScopes
·· $
;
··$ %
return
„„ 
vm
„„ 
;
„„ 
}
‰‰ 	
private
ÊÊ 
ScopeViewModel
ÊÊ "
CreateScopeViewModel
ÊÊ 3
(
ÊÊ3 4
IdentityResource
ÊÊ4 D
identity
ÊÊE M
,
ÊÊM N
bool
ÊÊO S
check
ÊÊT Y
)
ÊÊY Z
{
ÁÁ 	
return
ËË 
new
ËË 
ScopeViewModel
ËË %
{
ÈÈ 
Name
ÍÍ 
=
ÍÍ 
identity
ÍÍ 
.
ÍÍ  
Name
ÍÍ  $
,
ÍÍ$ %
Value
ÎÎ 
=
ÎÎ 
identity
ÎÎ  
.
ÎÎ  !
Name
ÎÎ! %
,
ÎÎ% &
DisplayName
ÏÏ 
=
ÏÏ 
identity
ÏÏ &
.
ÏÏ& '
DisplayName
ÏÏ' 2
??
ÏÏ3 5
identity
ÏÏ6 >
.
ÏÏ> ?
Name
ÏÏ? C
,
ÏÏC D
Description
ÌÌ 
=
ÌÌ 
identity
ÌÌ &
.
ÌÌ& '
Description
ÌÌ' 2
,
ÌÌ2 3
	Emphasize
ÓÓ 
=
ÓÓ 
identity
ÓÓ $
.
ÓÓ$ %
	Emphasize
ÓÓ% .
,
ÓÓ. /
Required
ÔÔ 
=
ÔÔ 
identity
ÔÔ #
.
ÔÔ# $
Required
ÔÔ$ ,
,
ÔÔ, -
Checked
 
=
 
check
 
||
  "
identity
# +
.
+ ,
Required
, 4
}
ÒÒ 
;
ÒÒ 
}
ÚÚ 	
public
ÙÙ 
ScopeViewModel
ÙÙ "
CreateScopeViewModel
ÙÙ 2
(
ÙÙ2 3
ParsedScopeValue
ÙÙ3 C
parsedScopeValue
ÙÙD T
,
ÙÙT U
ApiScope
ÙÙV ^
apiScope
ÙÙ_ g
,
ÙÙg h
bool
ÙÙi m
check
ÙÙn s
)
ÙÙs t
{
ıı 	
var
ˆˆ 
displayName
ˆˆ 
=
ˆˆ 
apiScope
ˆˆ &
.
ˆˆ& '
DisplayName
ˆˆ' 2
??
ˆˆ3 5
apiScope
ˆˆ6 >
.
ˆˆ> ?
Name
ˆˆ? C
;
ˆˆC D
if
˜˜ 
(
˜˜ 
!
˜˜ 
String
˜˜ 
.
˜˜  
IsNullOrWhiteSpace
˜˜ *
(
˜˜* +
parsedScopeValue
˜˜+ ;
.
˜˜; <
ParsedParameter
˜˜< K
)
˜˜K L
)
˜˜L M
{
¯¯ 
displayName
˘˘ 
+=
˘˘ 
$str
˘˘ "
+
˘˘# $
parsedScopeValue
˘˘% 5
.
˘˘5 6
ParsedParameter
˘˘6 E
;
˘˘E F
}
˙˙ 
return
¸¸ 
new
¸¸ 
ScopeViewModel
¸¸ %
{
˝˝ 
Name
˛˛ 
=
˛˛ 
parsedScopeValue
˛˛ '
.
˛˛' (

ParsedName
˛˛( 2
,
˛˛2 3
Value
ˇˇ 
=
ˇˇ 
parsedScopeValue
ˇˇ (
.
ˇˇ( )
RawValue
ˇˇ) 1
,
ˇˇ1 2
DisplayName
ÄÄ 
=
ÄÄ 
displayName
ÄÄ )
,
ÄÄ) *
Description
ÅÅ 
=
ÅÅ 
apiScope
ÅÅ &
.
ÅÅ& '
Description
ÅÅ' 2
,
ÅÅ2 3
	Emphasize
ÇÇ 
=
ÇÇ 
apiScope
ÇÇ $
.
ÇÇ$ %
	Emphasize
ÇÇ% .
,
ÇÇ. /
Required
ÉÉ 
=
ÉÉ 
apiScope
ÉÉ #
.
ÉÉ# $
Required
ÉÉ$ ,
,
ÉÉ, -
Checked
ÑÑ 
=
ÑÑ 
check
ÑÑ 
||
ÑÑ  "
apiScope
ÑÑ# +
.
ÑÑ+ ,
Required
ÑÑ, 4
}
ÖÖ 
;
ÖÖ 
}
ÜÜ 	
private
àà 
ScopeViewModel
àà #
GetOfflineAccessScope
àà 4
(
àà4 5
bool
àà5 9
check
àà: ?
)
àà? @
{
ââ 	
return
ää 
new
ää 
ScopeViewModel
ää %
{
ãã 
Value
åå 
=
åå 
Duende
åå 
.
åå 
IdentityServer
åå -
.
åå- .%
IdentityServerConstants
åå. E
.
ååE F
StandardScopes
ååF T
.
ååT U
OfflineAccess
ååU b
,
ååb c
DisplayName
çç 
=
çç 
ConsentOptions
çç ,
.
çç, -&
OfflineAccessDisplayName
çç- E
,
ççE F
Description
éé 
=
éé 
ConsentOptions
éé ,
.
éé, -&
OfflineAccessDescription
éé- E
,
ééE F
	Emphasize
èè 
=
èè 
true
èè  
,
èè  !
Checked
êê 
=
êê 
check
êê 
}
ëë 
;
ëë 
}
íí 	
}
ìì 
}îî ∞	
d/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ConsentInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ConsentInputModel		 "
{

 
public 
string 
Button 
{ 
get "
;" #
set$ '
;' (
}) *
public 
IEnumerable 
< 
string !
>! "
ScopesConsented# 2
{3 4
get5 8
;8 9
set: =
;= >
}? @
public 
bool 
RememberConsent #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
string 
	ReturnUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} ›
a/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ConsentOptions.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ConsentOptions 
{ 
public		 
static		 
bool		 
EnableOfflineAccess		 .
=		/ 0
true		1 5
;		5 6
public

 
static

 
string

 $
OfflineAccessDisplayName

 5
=

6 7
$str

8 H
;

H I
public 
static 
string $
OfflineAccessDescription 5
=6 7
$str8 ~
;~ 
public 
static 
readonly 
string %%
MustChooseOneErrorMessage& ?
=@ A
$strB i
;i j
public 
static 
readonly 
string %(
InvalidSelectionErrorMessage& B
=C D
$strE X
;X Y
} 
}  
c/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ConsentViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ConsentViewModel		 !
:		" #
ConsentInputModel		$ 5
{

 
public 
string 

ClientName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
	ClientUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
ClientLogoUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
bool  
AllowRememberConsent (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 
IEnumerable 
< 
ScopeViewModel )
>) *
IdentityScopes+ 9
{: ;
get< ?
;? @
setA D
;D E
}F G
public 
IEnumerable 
< 
ScopeViewModel )
>) *
	ApiScopes+ 4
{5 6
get7 :
;: ;
set< ?
;? @
}A B
} 
} ∏
g/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ProcessConsentResult.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		  
ProcessConsentResult		 %
{

 
public 
bool 

IsRedirect 
=> !
RedirectUri" -
!=. 0
null1 5
;5 6
public 
string 
RedirectUri !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
Client 
Client 
{ 
get "
;" #
set$ '
;' (
}) *
public 
bool 
ShowView 
=> 
	ViewModel  )
!=* ,
null- 1
;1 2
public 
ConsentViewModel 
	ViewModel  )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public 
bool 
HasValidationError &
=>' )
ValidationError* 9
!=: <
null= A
;A B
public 
string 
ValidationError %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} 
} ñ
d/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ResourceViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
ResourceViewModel "
{ 
public		 
string		 
Name		 
{		 
get		  
;		  !
set		" %
;		% &
}		' (
public

 
string

 
DisplayName

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
} 
} ı
a/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Consent/ScopeViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ScopeViewModel		 
{

 
public 
string 
Name 
{ 
get  
;  !
set" %
;% &
}' (
public 
string 
Value 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
DisplayName !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
bool 
	Emphasize 
{ 
get  #
;# $
set% (
;( )
}* +
public 
bool 
Required 
{ 
get "
;" #
set$ '
;' (
}) *
public 
bool 
Checked 
{ 
get !
;! "
set# &
;& '
}( )
public 
IEnumerable 
< 
ResourceViewModel ,
>, -
	Resources. 7
{8 9
get: =
;= >
set? B
;B C
}D E
} 
} ¿
o/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Device/DeviceAuthorizationInputModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class )
DeviceAuthorizationInputModel .
:/ 0
ConsentInputModel1 B
{ 
public		 
string		 
UserCode		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} ﬁ
n/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Device/DeviceAuthorizationViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class (
DeviceAuthorizationViewModel -
:. /
ConsentViewModel0 @
{ 
public		 
string		 
UserCode		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
public

 
bool

 
ConfirmUserCode

 #
{

$ %
get

& )
;

) *
set

+ .
;

. /
}

0 1
} 
} Î©
b/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Device/DeviceController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
	Authorize 
] 
[ 
SecurityHeaders 
] 
public 

class 
DeviceController !
:" #

Controller$ .
{ 
private 
readonly )
IDeviceFlowInteractionService 6
_interaction7 C
;C D
private 
readonly 
IEventService &
_events' .
;. /
private 
readonly 
IOptions !
<! "!
IdentityServerOptions" 7
>7 8
_options9 A
;A B
private 
readonly 
ILogger  
<  !
DeviceController! 1
>1 2
_logger3 :
;: ;
public 
DeviceController 
(  )
IDeviceFlowInteractionService   )
interaction  * 5
,  5 6
IEventService!! 
eventService!! &
,!!& '
IOptions"" 
<"" !
IdentityServerOptions"" *
>""* +
options"", 3
,""3 4
ILogger## 
<## 
DeviceController## $
>##$ %
logger##& ,
)##, -
{$$ 	
_interaction%% 
=%% 
interaction%% &
;%%& '
_events&& 
=&& 
eventService&& "
;&&" #
_options'' 
='' 
options'' 
;'' 
_logger(( 
=(( 
logger(( 
;(( 
})) 	
[++ 	
HttpGet++	 
]++ 
public,, 
async,, 
Task,, 
<,, 
IActionResult,, '
>,,' (
Index,,) .
(,,. /
),,/ 0
{-- 	
string.. 
userCodeParamName.. $
=..% &
_options..' /
.../ 0
Value..0 5
...5 6
UserInteraction..6 E
...E F/
#DeviceVerificationUserCodeParameter..F i
;..i j
string// 
userCode// 
=// 
Request// %
.//% &
Query//& +
[//+ ,
userCodeParamName//, =
]//= >
;//> ?
if00 
(00 
string00 
.00 
IsNullOrWhiteSpace00 )
(00) *
userCode00* 2
)002 3
)003 4
return005 ;
View00< @
(00@ A
$str00A R
)00R S
;00S T
var22 
vm22 
=22 
await22 
BuildViewModelAsync22 .
(22. /
userCode22/ 7
)227 8
;228 9
if33 
(33 
vm33 
==33 
null33 
)33 
return33 "
View33# '
(33' (
$str33( /
)33/ 0
;330 1
vm55 
.55 
ConfirmUserCode55 
=55  
true55! %
;55% &
return66 
View66 
(66 
$str66 .
,66. /
vm660 2
)662 3
;663 4
}77 	
[99 	
HttpPost99	 
]99 
[:: 	$
ValidateAntiForgeryToken::	 !
]::! "
public;; 
async;; 
Task;; 
<;; 
IActionResult;; '
>;;' (
UserCodeCapture;;) 8
(;;8 9
string;;9 ?
userCode;;@ H
);;H I
{<< 	
var== 
vm== 
=== 
await== 
BuildViewModelAsync== .
(==. /
userCode==/ 7
)==7 8
;==8 9
if>> 
(>> 
vm>> 
==>> 
null>> 
)>> 
return>> "
View>># '
(>>' (
$str>>( /
)>>/ 0
;>>0 1
return@@ 
View@@ 
(@@ 
$str@@ .
,@@. /
vm@@0 2
)@@2 3
;@@3 4
}AA 	
[CC 	
HttpPostCC	 
]CC 
[DD 	$
ValidateAntiForgeryTokenDD	 !
]DD! "
publicEE 
asyncEE 
TaskEE 
<EE 
IActionResultEE '
>EE' (
CallbackEE) 1
(EE1 2)
DeviceAuthorizationInputModelEE2 O
modelEEP U
)EEU V
{FF 	
ifGG 
(GG 
modelGG 
==GG 
nullGG 
)GG 
throwGG $
newGG% (!
ArgumentNullExceptionGG) >
(GG> ?
nameofGG? E
(GGE F
modelGGF K
)GGK L
)GGL M
;GGM N
varII 
resultII 
=II 
awaitII 
ProcessConsentII -
(II- .
modelII. 3
)II3 4
;II4 5
ifJJ 
(JJ 
resultJJ 
.JJ 
HasValidationErrorJJ )
)JJ) *
returnJJ+ 1
ViewJJ2 6
(JJ6 7
$strJJ7 >
)JJ> ?
;JJ? @
returnLL 
ViewLL 
(LL 
$strLL !
)LL! "
;LL" #
}MM 	
privateOO 
asyncOO 
TaskOO 
<OO  
ProcessConsentResultOO /
>OO/ 0
ProcessConsentOO1 ?
(OO? @)
DeviceAuthorizationInputModelOO@ ]
modelOO^ c
)OOc d
{PP 	
varQQ 
resultQQ 
=QQ 
newQQ  
ProcessConsentResultQQ 1
(QQ1 2
)QQ2 3
;QQ3 4
varSS 
requestSS 
=SS 
awaitSS 
_interactionSS  ,
.SS, -(
GetAuthorizationContextAsyncSS- I
(SSI J
modelSSJ O
.SSO P
UserCodeSSP X
)SSX Y
;SSY Z
ifTT 
(TT 
requestTT 
==TT 
nullTT 
)TT  
returnTT! '
resultTT( .
;TT. /
ConsentResponseVV 
grantedConsentVV *
=VV+ ,
nullVV- 1
;VV1 2
ifYY 
(YY 
modelYY 
.YY 
ButtonYY 
==YY 
$strYY  $
)YY$ %
{ZZ 
grantedConsent[[ 
=[[  
new[[! $
ConsentResponse[[% 4
{[[5 6
Error[[7 <
=[[= >
AuthorizationError[[? Q
.[[Q R
AccessDenied[[R ^
}[[_ `
;[[` a
await^^ 
_events^^ 
.^^ 

RaiseAsync^^ (
(^^( )
new^^) ,
ConsentDeniedEvent^^- ?
(^^? @
User^^@ D
.^^D E
GetSubjectId^^E Q
(^^Q R
)^^R S
,^^S T
request^^U \
.^^\ ]
Client^^] c
.^^c d
ClientId^^d l
,^^l m
request^^n u
.^^u v
ValidatedResources	^^v à
.
^^à â
RawScopeValues
^^â ó
)
^^ó ò
)
^^ò ô
;
^^ô ö
}__ 
elseaa 
ifaa 
(aa 
modelaa 
.aa 
Buttonaa !
==aa" $
$straa% *
)aa* +
{bb 
ifdd 
(dd 
modeldd 
.dd 
ScopesConsenteddd )
!=dd* ,
nulldd- 1
&&dd2 4
modeldd5 :
.dd: ;
ScopesConsenteddd; J
.ddJ K
AnyddK N
(ddN O
)ddO P
)ddP Q
{ee 
varff 
scopesff 
=ff  
modelff! &
.ff& '
ScopesConsentedff' 6
;ff6 7
ifgg 
(gg 
ConsentOptionsgg &
.gg& '
EnableOfflineAccessgg' :
==gg; =
falsegg> C
)ggC D
{hh 
scopesii 
=ii  
scopesii! '
.ii' (
Whereii( -
(ii- .
xii. /
=>ii0 2
xii3 4
!=ii5 7
Duendeii8 >
.ii> ?
IdentityServerii? M
.iiM N#
IdentityServerConstantsiiN e
.iie f
StandardScopesiif t
.iit u
OfflineAccess	iiu Ç
)
iiÇ É
;
iiÉ Ñ
}jj 
grantedConsentll "
=ll# $
newll% (
ConsentResponsell) 8
{mm 
RememberConsentnn '
=nn( )
modelnn* /
.nn/ 0
RememberConsentnn0 ?
,nn? @!
ScopesValuesConsentedoo -
=oo. /
scopesoo0 6
.oo6 7
ToArrayoo7 >
(oo> ?
)oo? @
,oo@ A
Descriptionpp #
=pp$ %
modelpp& +
.pp+ ,
Descriptionpp, 7
}qq 
;qq 
awaittt 
_eventstt !
.tt! "

RaiseAsynctt" ,
(tt, -
newtt- 0
ConsentGrantedEventtt1 D
(ttD E
UserttE I
.ttI J
GetSubjectIdttJ V
(ttV W
)ttW X
,ttX Y
requestttZ a
.tta b
Clientttb h
.tth i
ClientIdtti q
,ttq r
requesttts z
.ttz {
ValidatedResources	tt{ ç
.
ttç é
RawScopeValues
tté ú
,
ttú ù
grantedConsent
ttû ¨
.
tt¨ ≠#
ScopesValuesConsented
tt≠ ¬
,
tt¬ √
grantedConsent
ttƒ “
.
tt“ ”
RememberConsent
tt” ‚
)
tt‚ „
)
tt„ ‰
;
tt‰ Â
}uu 
elsevv 
{ww 
resultxx 
.xx 
ValidationErrorxx *
=xx+ ,
ConsentOptionsxx- ;
.xx; <%
MustChooseOneErrorMessagexx< U
;xxU V
}yy 
}zz 
else{{ 
{|| 
result}} 
.}} 
ValidationError}} &
=}}' (
ConsentOptions}}) 7
.}}7 8(
InvalidSelectionErrorMessage}}8 T
;}}T U
}~~ 
if
ÄÄ 
(
ÄÄ 
grantedConsent
ÄÄ 
!=
ÄÄ !
null
ÄÄ" &
)
ÄÄ& '
{
ÅÅ 
await
ÉÉ 
_interaction
ÉÉ "
.
ÉÉ" # 
HandleRequestAsync
ÉÉ# 5
(
ÉÉ5 6
model
ÉÉ6 ;
.
ÉÉ; <
UserCode
ÉÉ< D
,
ÉÉD E
grantedConsent
ÉÉF T
)
ÉÉT U
;
ÉÉU V
result
ÜÜ 
.
ÜÜ 
RedirectUri
ÜÜ "
=
ÜÜ# $
model
ÜÜ% *
.
ÜÜ* +
	ReturnUrl
ÜÜ+ 4
;
ÜÜ4 5
result
áá 
.
áá 
Client
áá 
=
áá 
request
áá  '
.
áá' (
Client
áá( .
;
áá. /
}
àà 
else
ââ 
{
ää 
result
åå 
.
åå 
	ViewModel
åå  
=
åå! "
await
åå# (!
BuildViewModelAsync
åå) <
(
åå< =
model
åå= B
.
ååB C
UserCode
ååC K
,
ååK L
model
ååM R
)
ååR S
;
ååS T
}
çç 
return
èè 
result
èè 
;
èè 
}
êê 	
private
íí 
async
íí 
Task
íí 
<
íí *
DeviceAuthorizationViewModel
íí 7
>
íí7 8!
BuildViewModelAsync
íí9 L
(
ííL M
string
ííM S
userCode
ííT \
,
íí\ ]+
DeviceAuthorizationInputModel
íí^ {
modelíí| Å
=ííÇ É
nullííÑ à
)ííà â
{
ìì 	
var
îî 
request
îî 
=
îî 
await
îî 
_interaction
îî  ,
.
îî, -*
GetAuthorizationContextAsync
îî- I
(
îîI J
userCode
îîJ R
)
îîR S
;
îîS T
if
ïï 
(
ïï 
request
ïï 
!=
ïï 
null
ïï 
)
ïï  
{
ññ 
return
óó $
CreateConsentViewModel
óó -
(
óó- .
userCode
óó. 6
,
óó6 7
model
óó8 =
,
óó= >
request
óó? F
)
óóF G
;
óóG H
}
òò 
return
öö 
null
öö 
;
öö 
}
õõ 	
private
ùù *
DeviceAuthorizationViewModel
ùù ,$
CreateConsentViewModel
ùù- C
(
ùùC D
string
ùùD J
userCode
ùùK S
,
ùùS T+
DeviceAuthorizationInputModel
ùùU r
model
ùùs x
,
ùùx y-
DeviceFlowAuthorizationRequestùùz ò
requestùùô †
)ùù† °
{
ûû 	
var
üü 
vm
üü 
=
üü 
new
üü *
DeviceAuthorizationViewModel
üü 5
{
†† 
UserCode
°° 
=
°° 
userCode
°° #
,
°°# $
Description
¢¢ 
=
¢¢ 
model
¢¢ #
?
¢¢# $
.
¢¢$ %
Description
¢¢% 0
,
¢¢0 1
RememberConsent
§§ 
=
§§  !
model
§§" '
?
§§' (
.
§§( )
RememberConsent
§§) 8
??
§§9 ;
true
§§< @
,
§§@ A
ScopesConsented
•• 
=
••  !
model
••" '
?
••' (
.
••( )
ScopesConsented
••) 8
??
••9 ;

Enumerable
••< F
.
••F G
Empty
••G L
<
••L M
string
••M S
>
••S T
(
••T U
)
••U V
,
••V W

ClientName
ßß 
=
ßß 
request
ßß $
.
ßß$ %
Client
ßß% +
.
ßß+ ,

ClientName
ßß, 6
??
ßß7 9
request
ßß: A
.
ßßA B
Client
ßßB H
.
ßßH I
ClientId
ßßI Q
,
ßßQ R
	ClientUrl
®® 
=
®® 
request
®® #
.
®®# $
Client
®®$ *
.
®®* +
	ClientUri
®®+ 4
,
®®4 5
ClientLogoUrl
©© 
=
©© 
request
©©  '
.
©©' (
Client
©©( .
.
©©. /
LogoUri
©©/ 6
,
©©6 7"
AllowRememberConsent
™™ $
=
™™% &
request
™™' .
.
™™. /
Client
™™/ 5
.
™™5 6"
AllowRememberConsent
™™6 J
}
´´ 
;
´´ 
vm
≠≠ 
.
≠≠ 
IdentityScopes
≠≠ 
=
≠≠ 
request
≠≠  '
.
≠≠' ( 
ValidatedResources
≠≠( :
.
≠≠: ;
	Resources
≠≠; D
.
≠≠D E
IdentityResources
≠≠E V
.
≠≠V W
Select
≠≠W ]
(
≠≠] ^
x
≠≠^ _
=>
≠≠` b"
CreateScopeViewModel
≠≠c w
(
≠≠w x
x
≠≠x y
,
≠≠y z
vm
≠≠{ }
.
≠≠} ~
ScopesConsented≠≠~ ç
.≠≠ç é
Contains≠≠é ñ
(≠≠ñ ó
x≠≠ó ò
.≠≠ò ô
Name≠≠ô ù
)≠≠ù û
||≠≠ü °
model≠≠¢ ß
==≠≠® ™
null≠≠´ Ø
)≠≠Ø ∞
)≠≠∞ ±
.≠≠± ≤
ToArray≠≠≤ π
(≠≠π ∫
)≠≠∫ ª
;≠≠ª º
var
ØØ 
	apiScopes
ØØ 
=
ØØ 
new
ØØ 
List
ØØ  $
<
ØØ$ %
ScopeViewModel
ØØ% 3
>
ØØ3 4
(
ØØ4 5
)
ØØ5 6
;
ØØ6 7
foreach
∞∞ 
(
∞∞ 
var
∞∞ 
parsedScope
∞∞ $
in
∞∞% '
request
∞∞( /
.
∞∞/ 0 
ValidatedResources
∞∞0 B
.
∞∞B C
ParsedScopes
∞∞C O
)
∞∞O P
{
±± 
var
≤≤ 
apiScope
≤≤ 
=
≤≤ 
request
≤≤ &
.
≤≤& ' 
ValidatedResources
≤≤' 9
.
≤≤9 :
	Resources
≤≤: C
.
≤≤C D
FindApiScope
≤≤D P
(
≤≤P Q
parsedScope
≤≤Q \
.
≤≤\ ]

ParsedName
≤≤] g
)
≤≤g h
;
≤≤h i
if
≥≥ 
(
≥≥ 
apiScope
≥≥ 
!=
≥≥ 
null
≥≥  $
)
≥≥$ %
{
¥¥ 
var
µµ 
scopeVm
µµ 
=
µµ  !"
CreateScopeViewModel
µµ" 6
(
µµ6 7
parsedScope
µµ7 B
,
µµB C
apiScope
µµD L
,
µµL M
vm
µµN P
.
µµP Q
ScopesConsented
µµQ `
.
µµ` a
Contains
µµa i
(
µµi j
parsedScope
µµj u
.
µµu v
RawValue
µµv ~
)
µµ~ 
||µµÄ Ç
modelµµÉ à
==µµâ ã
nullµµå ê
)µµê ë
;µµë í
	apiScopes
∂∂ 
.
∂∂ 
Add
∂∂ !
(
∂∂! "
scopeVm
∂∂" )
)
∂∂) *
;
∂∂* +
}
∑∑ 
}
∏∏ 
if
ππ 
(
ππ 
ConsentOptions
ππ 
.
ππ !
EnableOfflineAccess
ππ 2
&&
ππ3 5
request
ππ6 =
.
ππ= > 
ValidatedResources
ππ> P
.
ππP Q
	Resources
ππQ Z
.
ππZ [
OfflineAccess
ππ[ h
)
ππh i
{
∫∫ 
	apiScopes
ªª 
.
ªª 
Add
ªª 
(
ªª #
GetOfflineAccessScope
ªª 3
(
ªª3 4
vm
ªª4 6
.
ªª6 7
ScopesConsented
ªª7 F
.
ªªF G
Contains
ªªG O
(
ªªO P
Duende
ªªP V
.
ªªV W
IdentityServer
ªªW e
.
ªªe f%
IdentityServerConstants
ªªf }
.
ªª} ~
StandardScopesªª~ å
.ªªå ç
OfflineAccessªªç ö
)ªªö õ
||ªªú û
modelªªü §
==ªª• ß
nullªª® ¨
)ªª¨ ≠
)ªª≠ Æ
;ªªÆ Ø
}
ºº 
vm
ΩΩ 
.
ΩΩ 
	ApiScopes
ΩΩ 
=
ΩΩ 
	apiScopes
ΩΩ $
;
ΩΩ$ %
return
øø 
vm
øø 
;
øø 
}
¿¿ 	
private
¬¬ 
ScopeViewModel
¬¬ "
CreateScopeViewModel
¬¬ 3
(
¬¬3 4
IdentityResource
¬¬4 D
identity
¬¬E M
,
¬¬M N
bool
¬¬O S
check
¬¬T Y
)
¬¬Y Z
{
√√ 	
return
ƒƒ 
new
ƒƒ 
ScopeViewModel
ƒƒ %
{
≈≈ 
Value
∆∆ 
=
∆∆ 
identity
∆∆  
.
∆∆  !
Name
∆∆! %
,
∆∆% &
DisplayName
«« 
=
«« 
identity
«« &
.
««& '
DisplayName
««' 2
??
««3 5
identity
««6 >
.
««> ?
Name
««? C
,
««C D
Description
»» 
=
»» 
identity
»» &
.
»»& '
Description
»»' 2
,
»»2 3
	Emphasize
…… 
=
…… 
identity
…… $
.
……$ %
	Emphasize
……% .
,
……. /
Required
   
=
   
identity
   #
.
  # $
Required
  $ ,
,
  , -
Checked
ÀÀ 
=
ÀÀ 
check
ÀÀ 
||
ÀÀ  "
identity
ÀÀ# +
.
ÀÀ+ ,
Required
ÀÀ, 4
}
ÃÃ 
;
ÃÃ 
}
ÕÕ 	
public
œœ 
ScopeViewModel
œœ "
CreateScopeViewModel
œœ 2
(
œœ2 3
ParsedScopeValue
œœ3 C
parsedScopeValue
œœD T
,
œœT U
ApiScope
œœV ^
apiScope
œœ_ g
,
œœg h
bool
œœi m
check
œœn s
)
œœs t
{
–– 	
return
—— 
new
—— 
ScopeViewModel
—— %
{
““ 
Value
”” 
=
”” 
parsedScopeValue
”” (
.
””( )
RawValue
””) 1
,
””1 2
DisplayName
’’ 
=
’’ 
apiScope
’’ &
.
’’& '
DisplayName
’’' 2
??
’’3 5
apiScope
’’6 >
.
’’> ?
Name
’’? C
,
’’C D
Description
÷÷ 
=
÷÷ 
apiScope
÷÷ &
.
÷÷& '
Description
÷÷' 2
,
÷÷2 3
	Emphasize
◊◊ 
=
◊◊ 
apiScope
◊◊ $
.
◊◊$ %
	Emphasize
◊◊% .
,
◊◊. /
Required
ÿÿ 
=
ÿÿ 
apiScope
ÿÿ #
.
ÿÿ# $
Required
ÿÿ$ ,
,
ÿÿ, -
Checked
ŸŸ 
=
ŸŸ 
check
ŸŸ 
||
ŸŸ  "
apiScope
ŸŸ# +
.
ŸŸ+ ,
Required
ŸŸ, 4
}
⁄⁄ 
;
⁄⁄ 
}
€€ 	
private
‹‹ 
ScopeViewModel
‹‹ #
GetOfflineAccessScope
‹‹ 4
(
‹‹4 5
bool
‹‹5 9
check
‹‹: ?
)
‹‹? @
{
›› 	
return
ﬁﬁ 
new
ﬁﬁ 
ScopeViewModel
ﬁﬁ %
{
ﬂﬂ 
Value
‡‡ 
=
‡‡ 
Duende
‡‡ 
.
‡‡ 
IdentityServer
‡‡ -
.
‡‡- .%
IdentityServerConstants
‡‡. E
.
‡‡E F
StandardScopes
‡‡F T
.
‡‡T U
OfflineAccess
‡‡U b
,
‡‡b c
DisplayName
·· 
=
·· 
ConsentOptions
·· ,
.
··, -&
OfflineAccessDisplayName
··- E
,
··E F
Description
‚‚ 
=
‚‚ 
ConsentOptions
‚‚ ,
.
‚‚, -&
OfflineAccessDescription
‚‚- E
,
‚‚E F
	Emphasize
„„ 
=
„„ 
true
„„  
,
„„  !
Checked
‰‰ 
=
‰‰ 
check
‰‰ 
}
ÂÂ 
;
ÂÂ 
}
ÊÊ 	
}
ÁÁ 
}ËË ê
l/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Diagnostics/DiagnosticsController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class !
DiagnosticsController &
:' (

Controller) 3
{ 
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
var 
localAddresses 
=  
new! $
string% +
[+ ,
], -
{. /
$str0 ;
,; <
$str= B
,B C
HttpContextD O
.O P

ConnectionP Z
.Z [
LocalIpAddress[ i
.i j
ToStringj r
(r s
)s t
}u v
;v w
if 
( 
! 
localAddresses 
.  
Contains  (
(( )
HttpContext) 4
.4 5

Connection5 ?
.? @
RemoteIpAddress@ O
.O P
ToStringP X
(X Y
)Y Z
)Z [
)[ \
{ 
return 
NotFound 
(  
)  !
;! "
} 
var 
model 
= 
new  
DiagnosticsViewModel 0
(0 1
await1 6
HttpContext7 B
.B C
AuthenticateAsyncC T
(T U
)U V
)V W
;W X
return 
View 
( 
model 
) 
; 
} 	
} 
} ˇ
k/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Diagnostics/DiagnosticsViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class  
DiagnosticsViewModel %
{ 
public  
DiagnosticsViewModel #
(# $
AuthenticateResult$ 6
result7 =
)= >
{ 	
AuthenticateResult 
=  
result! '
;' (
if 
( 
result 
. 

Properties !
.! "
Items" '
.' (
ContainsKey( 3
(3 4
$str4 A
)A B
)B C
{ 
var 
encoded 
= 
result $
.$ %

Properties% /
./ 0
Items0 5
[5 6
$str6 C
]C D
;D E
var 
bytes 
= 
	Base64Url %
.% &
Decode& ,
(, -
encoded- 4
)4 5
;5 6
var 
value 
= 
Encoding $
.$ %
UTF8% )
.) *
	GetString* 3
(3 4
bytes4 9
)9 :
;: ;
Clients 
= 
JsonSerializer (
.( )
Deserialize) 4
<4 5
string5 ;
[; <
]< =
>= >
(> ?
value? D
)D E
;E F
} 
} 	
public 
AuthenticateResult !
AuthenticateResult" 4
{5 6
get7 :
;: ;
}< =
public 
IEnumerable 
< 
string !
>! "
Clients# *
{+ ,
get- 0
;0 1
}2 3
=4 5
new6 9
List: >
<> ?
string? E
>E F
(F G
)G H
;H I
} 
}   ı
U/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Extensions.cs
	namespace		 	
IdentityServerHost		
 
.		 

Quickstart		 '
.		' (
UI		( *
{

 
public 

static 
class 

Extensions "
{ 
public 
static 
bool 
IsNativeClient )
() *
this* . 
AuthorizationRequest/ C
contextD K
)K L
{ 	
return 
! 
context 
. 
RedirectUri '
.' (

StartsWith( 2
(2 3
$str3 :
,: ;
StringComparison< L
.L M
OrdinalM T
)T U
&& 
! 
context 
. 
RedirectUri &
.& '

StartsWith' 1
(1 2
$str2 8
,8 9
StringComparison: J
.J K
OrdinalK R
)R S
;S T
} 	
public 
static 
IActionResult #
LoadingPage$ /
(/ 0
this0 4

Controller5 ?

controller@ J
,J K
stringL R
viewNameS [
,[ \
string] c
redirectUrid o
)o p
{ 	

controller 
. 
HttpContext "
." #
Response# +
.+ ,

StatusCode, 6
=7 8
$num9 <
;< =

controller 
. 
HttpContext "
." #
Response# +
.+ ,
Headers, 3
[3 4
$str4 >
]> ?
=@ A
$strB D
;D E
return 

controller 
. 
View "
(" #
viewName# +
,+ ,
new- 0
RedirectViewModel1 B
{C D
RedirectUrlE P
=Q R
redirectUriS ^
}_ `
)` a
;a b
} 	
} 
} €2
b/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Grants/GrantsController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
	Authorize 
] 
public 

class 
GrantsController !
:" #

Controller$ .
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IClientStore %
_clients& .
;. /
private 
readonly 
IResourceStore '

_resources( 2
;2 3
private 
readonly 
IEventService &
_events' .
;. /
public 
GrantsController 
(  -
!IIdentityServerInteractionService  A
interactionB M
,M N
IClientStore 
clients  
,  !
IResourceStore 
	resources $
,$ %
IEventService   
events    
)    !
{!! 	
_interaction"" 
="" 
interaction"" &
;""& '
_clients## 
=## 
clients## 
;## 

_resources$$ 
=$$ 
	resources$$ "
;$$" #
_events%% 
=%% 
events%% 
;%% 
}&& 	
[++ 	
HttpGet++	 
]++ 
public,, 
async,, 
Task,, 
<,, 
IActionResult,, '
>,,' (
Index,,) .
(,,. /
),,/ 0
{-- 	
return.. 
View.. 
(.. 
$str.. 
,..  
await..! &
BuildViewModelAsync..' :
(..: ;
)..; <
)..< =
;..= >
}// 	
[44 	
HttpPost44	 
]44 
[55 	$
ValidateAntiForgeryToken55	 !
]55! "
public66 
async66 
Task66 
<66 
IActionResult66 '
>66' (
Revoke66) /
(66/ 0
string660 6
clientId667 ?
)66? @
{77 	
await88 
_interaction88 
.88 "
RevokeUserConsentAsync88 5
(885 6
clientId886 >
)88> ?
;88? @
await99 
_events99 
.99 

RaiseAsync99 $
(99$ %
new99% (
GrantsRevokedEvent99) ;
(99; <
User99< @
.99@ A
GetSubjectId99A M
(99M N
)99N O
,99O P
clientId99Q Y
)99Y Z
)99Z [
;99[ \
return;; 
RedirectToAction;; #
(;;# $
$str;;$ +
);;+ ,
;;;, -
}<< 	
private>> 
async>> 
Task>> 
<>> 
GrantsViewModel>> *
>>>* +
BuildViewModelAsync>>, ?
(>>? @
)>>@ A
{?? 	
var@@ 
grants@@ 
=@@ 
await@@ 
_interaction@@ +
.@@+ ,!
GetAllUserGrantsAsync@@, A
(@@A B
)@@B C
;@@C D
varBB 
listBB 
=BB 
newBB 
ListBB 
<BB  
GrantViewModelBB  .
>BB. /
(BB/ 0
)BB0 1
;BB1 2
foreachCC 
(CC 
varCC 
grantCC 
inCC  
grantsCC! '
)CC' (
{DD 
varEE 
clientEE 
=EE 
awaitEE "
_clientsEE# +
.EE+ ,
FindClientByIdAsyncEE, ?
(EE? @
grantEE@ E
.EEE F
ClientIdEEF N
)EEN O
;EEO P
ifFF 
(FF 
clientFF 
!=FF 
nullFF "
)FF" #
{GG 
varHH 
	resourcesHH !
=HH" #
awaitHH$ )

_resourcesHH* 4
.HH4 5%
FindResourcesByScopeAsyncHH5 N
(HHN O
grantHHO T
.HHT U
ScopesHHU [
)HH[ \
;HH\ ]
varJJ 
itemJJ 
=JJ 
newJJ "
GrantViewModelJJ# 1
(JJ1 2
)JJ2 3
{KK 
ClientIdLL  
=LL! "
clientLL# )
.LL) *
ClientIdLL* 2
,LL2 3

ClientNameMM "
=MM# $
clientMM% +
.MM+ ,

ClientNameMM, 6
??MM7 9
clientMM: @
.MM@ A
ClientIdMMA I
,MMI J
ClientLogoUrlNN %
=NN& '
clientNN( .
.NN. /
LogoUriNN/ 6
,NN6 7
	ClientUrlOO !
=OO" #
clientOO$ *
.OO* +
	ClientUriOO+ 4
,OO4 5
DescriptionPP #
=PP$ %
grantPP& +
.PP+ ,
DescriptionPP, 7
,PP7 8
CreatedQQ 
=QQ  !
grantQQ" '
.QQ' (
CreationTimeQQ( 4
,QQ4 5
ExpiresRR 
=RR  !
grantRR" '
.RR' (

ExpirationRR( 2
,RR2 3
IdentityGrantNamesSS *
=SS+ ,
	resourcesSS- 6
.SS6 7
IdentityResourcesSS7 H
.SSH I
SelectSSI O
(SSO P
xSSP Q
=>SSR T
xSSU V
.SSV W
DisplayNameSSW b
??SSc e
xSSf g
.SSg h
NameSSh l
)SSl m
.SSm n
ToArraySSn u
(SSu v
)SSv w
,SSw x
ApiGrantNamesTT %
=TT& '
	resourcesTT( 1
.TT1 2
	ApiScopesTT2 ;
.TT; <
SelectTT< B
(TTB C
xTTC D
=>TTE G
xTTH I
.TTI J
DisplayNameTTJ U
??TTV X
xTTY Z
.TTZ [
NameTT[ _
)TT_ `
.TT` a
ToArrayTTa h
(TTh i
)TTi j
}UU 
;UU 
listWW 
.WW 
AddWW 
(WW 
itemWW !
)WW! "
;WW" #
}XX 
}YY 
return[[ 
new[[ 
GrantsViewModel[[ &
{\\ 
Grants]] 
=]] 
list]] 
}^^ 
;^^ 
}__ 	
}`` 
}aa ©
a/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Grants/GrantsViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{		 
public

 

class

 
GrantsViewModel

  
{ 
public 
IEnumerable 
< 
GrantViewModel )
>) *
Grants+ 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
} 
public 

class 
GrantViewModel 
{ 
public 
string 
ClientId 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 

ClientName  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
	ClientUrl 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
ClientLogoUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 
string 
Description !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
DateTime 
Created 
{  !
get" %
;% &
set' *
;* +
}, -
public 
DateTime 
? 
Expires  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
IEnumerable 
< 
string !
>! "
IdentityGrantNames# 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
public 
IEnumerable 
< 
string !
>! "
ApiGrantNames# 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
} 
} £
^/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Home/ErrorViewModel.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public		 

class		 
ErrorViewModel		 
{

 
public 
ErrorViewModel 
( 
) 
{ 	
} 	
public 
ErrorViewModel 
( 
string $
error% *
)* +
{ 	
Error 
= 
new 
ErrorMessage $
{% &
Error' ,
=- .
error/ 4
}5 6
;6 7
} 	
public 
ErrorMessage 
Error !
{" #
get$ '
;' (
set) ,
;, -
}. /
} 
} Ê
^/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/Home/HomeController.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
readonly -
!IIdentityServerInteractionService :
_interaction; G
;G H
private 
readonly 
IWebHostEnvironment ,
_environment- 9
;9 :
private 
readonly 
ILogger  
_logger! (
;( )
public 
HomeController 
( -
!IIdentityServerInteractionService ?
interaction@ K
,K L
IWebHostEnvironmentM `
environmenta l
,l m
ILoggern u
<u v
HomeController	v Ñ
>
Ñ Ö
logger
Ü å
)
å ç
{ 	
_interaction 
= 
interaction &
;& '
_environment 
= 
environment &
;& '
_logger 
= 
logger 
; 
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
if   
(   
_environment   
.   
IsDevelopment   *
(  * +
)  + ,
)  , -
{!! 
return## 
View## 
(## 
)## 
;## 
}$$ 
_logger&& 
.&& 
LogInformation&& "
(&&" #
$str&&# W
)&&W X
;&&X Y
return'' 
NotFound'' 
('' 
)'' 
;'' 
}(( 	
public-- 
async-- 
Task-- 
<-- 
IActionResult-- '
>--' (
Error--) .
(--. /
string--/ 5
errorId--6 =
)--= >
{.. 	
var// 
vm// 
=// 
new// 
ErrorViewModel// '
(//' (
)//( )
;//) *
var22 
message22 
=22 
await22 
_interaction22  ,
.22, - 
GetErrorContextAsync22- A
(22A B
errorId22B I
)22I J
;22J K
if33 
(33 
message33 
!=33 
null33 
)33  
{44 
vm55 
.55 
Error55 
=55 
message55 "
;55" #
if77 
(77 
!77 
_environment77 !
.77! "
IsDevelopment77" /
(77/ 0
)770 1
)771 2
{88 
message:: 
.:: 
ErrorDescription:: ,
=::- .
null::/ 3
;::3 4
};; 
}<< 
return>> 
View>> 
(>> 
$str>> 
,>>  
vm>>! #
)>># $
;>>$ %
}?? 	
}@@ 
}AA ·
c/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/SecurityHeadersAttribute.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{		 
public

 

class

 $
SecurityHeadersAttribute

 )
:

* +!
ActionFilterAttribute

, A
{ 
public 
override 
void 
OnResultExecuting .
(. /"
ResultExecutingContext/ E
contextF M
)M N
{ 	
var 
result 
= 
context  
.  !
Result! '
;' (
if 
( 
result 
is 

ViewResult $
)$ %
{ 
if 
( 
! 
context 
. 
HttpContext (
.( )
Response) 1
.1 2
Headers2 9
.9 :
ContainsKey: E
(E F
$strF ^
)^ _
)_ `
{ 
context 
. 
HttpContext '
.' (
Response( 0
.0 1
Headers1 8
.8 9
Add9 <
(< =
$str= U
,U V
$strW `
)` a
;a b
} 
if 
( 
! 
context 
. 
HttpContext (
.( )
Response) 1
.1 2
Headers2 9
.9 :
ContainsKey: E
(E F
$strF W
)W X
)X Y
{ 
context 
. 
HttpContext '
.' (
Response( 0
.0 1
Headers1 8
.8 9
Add9 <
(< =
$str= N
,N O
$strP \
)\ ]
;] ^
} 
var 
csp 
= 
$str	 †
;
† °
if%% 
(%% 
!%% 
context%% 
.%% 
HttpContext%% (
.%%( )
Response%%) 1
.%%1 2
Headers%%2 9
.%%9 :
ContainsKey%%: E
(%%E F
$str%%F _
)%%_ `
)%%` a
{&& 
context'' 
.'' 
HttpContext'' '
.''' (
Response''( 0
.''0 1
Headers''1 8
.''8 9
Add''9 <
(''< =
$str''= V
,''V W
csp''X [
)''[ \
;''\ ]
}(( 
if** 
(** 
!** 
context** 
.** 
HttpContext** (
.**( )
Response**) 1
.**1 2
Headers**2 9
.**9 :
ContainsKey**: E
(**E F
$str**F a
)**a b
)**b c
{++ 
context,, 
.,, 
HttpContext,, '
.,,' (
Response,,( 0
.,,0 1
Headers,,1 8
.,,8 9
Add,,9 <
(,,< =
$str,,= X
,,,X Y
csp,,Z ]
),,] ^
;,,^ _
}-- 
var00 
referrer_policy00 #
=00$ %
$str00& 3
;003 4
if11 
(11 
!11 
context11 
.11 
HttpContext11 (
.11( )
Response11) 1
.111 2
Headers112 9
.119 :
ContainsKey11: E
(11E F
$str11F W
)11W X
)11X Y
{22 
context33 
.33 
HttpContext33 '
.33' (
Response33( 0
.330 1
Headers331 8
.338 9
Add339 <
(33< =
$str33= N
,33N O
referrer_policy33P _
)33_ `
;33` a
}44 
}55 
}66 	
}77 
}88 Ñ&
T/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/MainModule/TestUsers.cs
	namespace 	
IdentityServerHost
 
. 

Quickstart '
.' (
UI( *
{ 
public 

class 
	TestUsers 
{ 
public 
static 
List 
< 
TestUser #
># $
Users% *
{ 	
get 
{ 
var 
address 
= 
new !
{ 
street_address "
=# $
$str% 5
,5 6
locality 
= 
$str +
,+ ,
postal_code 
=  !
$num" '
,' (
country 
= 
$str '
} 
; 
return 
new 
List 
<  
TestUser  (
>( )
{ 
new 
TestUser  
{ 
	SubjectId   !
=  " #
$str  $ ,
,  , -
Username!!  
=!!! "
$str!!# *
,!!* +
Password""  
=""! "
$str""# *
,""* +
Claims## 
=##  
{$$ 
new%% 
Claim%%  %
(%%% &
JwtClaimTypes%%& 3
.%%3 4
Name%%4 8
,%%8 9
$str%%: G
)%%G H
,%%H I
new&& 
Claim&&  %
(&&% &
JwtClaimTypes&&& 3
.&&3 4
	GivenName&&4 =
,&&= >
$str&&? F
)&&F G
,&&G H
new'' 
Claim''  %
(''% &
JwtClaimTypes''& 3
.''3 4

FamilyName''4 >
,''> ?
$str''@ G
)''G H
,''H I
new(( 
Claim((  %
(((% &
JwtClaimTypes((& 3
.((3 4
Email((4 9
,((9 :
$str((; Q
)((Q R
,((R S
new)) 
Claim))  %
())% &
JwtClaimTypes))& 3
.))3 4
EmailVerified))4 A
,))A B
$str))C I
,))I J
ClaimValueTypes))K Z
.))Z [
Boolean))[ b
)))b c
,))c d
new** 
Claim**  %
(**% &
JwtClaimTypes**& 3
.**3 4
WebSite**4 ;
,**; <
$str**= O
)**O P
,**P Q
new++ 
Claim++  %
(++% &
JwtClaimTypes++& 3
.++3 4
Address++4 ;
,++; <
JsonSerializer++= K
.++K L
	Serialize++L U
(++U V
address++V ]
)++] ^
,++^ _#
IdentityServerConstants++` w
.++w x
ClaimValueTypes	++x á
.
++á à
Json
++à å
)
++å ç
},, 
}-- 
,-- 
new.. 
TestUser..  
{// 
	SubjectId00 !
=00" #
$str00$ .
,00. /
Username11  
=11! "
$str11# (
,11( )
Password22  
=22! "
$str22# (
,22( )
Claims33 
=33  
{44 
new55 
Claim55  %
(55% &
JwtClaimTypes55& 3
.553 4
Name554 8
,558 9
$str55: E
)55E F
,55F G
new66 
Claim66  %
(66% &
JwtClaimTypes66& 3
.663 4
	GivenName664 =
,66= >
$str66? D
)66D E
,66E F
new77 
Claim77  %
(77% &
JwtClaimTypes77& 3
.773 4

FamilyName774 >
,77> ?
$str77@ G
)77G H
,77H I
new88 
Claim88  %
(88% &
JwtClaimTypes88& 3
.883 4
Email884 9
,889 :
$str88; O
)88O P
,88P Q
new99 
Claim99  %
(99% &
JwtClaimTypes99& 3
.993 4
EmailVerified994 A
,99A B
$str99C I
,99I J
ClaimValueTypes99K Z
.99Z [
Boolean99[ b
)99b c
,99c d
new:: 
Claim::  %
(::% &
JwtClaimTypes::& 3
.::3 4
WebSite::4 ;
,::; <
$str::= M
)::M N
,::N O
new;; 
Claim;;  %
(;;% &
JwtClaimTypes;;& 3
.;;3 4
Address;;4 ;
,;;; <
JsonSerializer;;= K
.;;K L
	Serialize;;L U
(;;U V
address;;V ]
);;] ^
,;;^ _#
IdentityServerConstants;;` w
.;;w x
ClaimValueTypes	;;x á
.
;;á à
Json
;;à å
)
;;å ç
}<< 
}== 
}>> 
;>> 
}?? 
}@@ 	
}AA 
}BB º∆
x/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Migrations/20211230211547_ConfigureDefaultIdentityTables.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "

Migrations" ,
{ 
public 

partial 
class *
ConfigureDefaultIdentityTables 7
:8 9
	Migration: C
{		 
	protected

 
override

 
void

 
Up

  "
(

" #
MigrationBuilder

# 3
migrationBuilder

4 D
)

D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str #
,# $
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
string& ,
>, -
(- .
type. 2
:2 3
$str4 C
,C D
nullableE M
:M N
falseO T
)T U
,U V
Name 
= 
table  
.  !
Column! '
<' (
string( .
>. /
(/ 0
type0 4
:4 5
$str6 E
,E F
	maxLengthG P
:P Q
$numR U
,U V
nullableW _
:_ `
truea e
)e f
,f g
NormalizedName "
=# $
table% *
.* +
Column+ 1
<1 2
string2 8
>8 9
(9 :
type: >
:> ?
$str@ O
,O P
	maxLengthQ Z
:Z [
$num\ _
,_ `
nullablea i
:i j
truek o
)o p
,p q
ConcurrencyStamp $
=% &
table' ,
., -
Column- 3
<3 4
string4 :
>: ;
(; <
type< @
:@ A
$strB Q
,Q R
nullableS [
:[ \
true] a
)a b
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 5
,5 6
x7 8
=>9 ;
x< =
.= >
Id> @
)@ A
;A B
} 
) 
; 
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str #
,# $
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
string& ,
>, -
(- .
type. 2
:2 3
$str4 C
,C D
nullableE M
:M N
falseO T
)T U
,U V
UserName 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: I
,I J
	maxLengthK T
:T U
$numV Y
,Y Z
nullable[ c
:c d
truee i
)i j
,j k
NormalizedUserName   &
=  ' (
table  ) .
.  . /
Column  / 5
<  5 6
string  6 <
>  < =
(  = >
type  > B
:  B C
$str  D S
,  S T
	maxLength  U ^
:  ^ _
$num  ` c
,  c d
nullable  e m
:  m n
true  o s
)  s t
,  t u
Email!! 
=!! 
table!! !
.!!! "
Column!!" (
<!!( )
string!!) /
>!!/ 0
(!!0 1
type!!1 5
:!!5 6
$str!!7 F
,!!F G
	maxLength!!H Q
:!!Q R
$num!!S V
,!!V W
nullable!!X `
:!!` a
true!!b f
)!!f g
,!!g h
NormalizedEmail"" #
=""$ %
table""& +
.""+ ,
Column"", 2
<""2 3
string""3 9
>""9 :
("": ;
type""; ?
:""? @
$str""A P
,""P Q
	maxLength""R [
:""[ \
$num""] `
,""` a
nullable""b j
:""j k
true""l p
)""p q
,""q r
EmailConfirmed## "
=### $
table##% *
.##* +
Column##+ 1
<##1 2
bool##2 6
>##6 7
(##7 8
type##8 <
:##< =
$str##> C
,##C D
nullable##E M
:##M N
false##O T
)##T U
,##U V
PasswordHash$$  
=$$! "
table$$# (
.$$( )
Column$$) /
<$$/ 0
string$$0 6
>$$6 7
($$7 8
type$$8 <
:$$< =
$str$$> M
,$$M N
nullable$$O W
:$$W X
true$$Y ]
)$$] ^
,$$^ _
SecurityStamp%% !
=%%" #
table%%$ )
.%%) *
Column%%* 0
<%%0 1
string%%1 7
>%%7 8
(%%8 9
type%%9 =
:%%= >
$str%%? N
,%%N O
nullable%%P X
:%%X Y
true%%Z ^
)%%^ _
,%%_ `
ConcurrencyStamp&& $
=&&% &
table&&' ,
.&&, -
Column&&- 3
<&&3 4
string&&4 :
>&&: ;
(&&; <
type&&< @
:&&@ A
$str&&B Q
,&&Q R
nullable&&S [
:&&[ \
true&&] a
)&&a b
,&&b c
PhoneNumber'' 
=''  !
table''" '
.''' (
Column''( .
<''. /
string''/ 5
>''5 6
(''6 7
type''7 ;
:''; <
$str''= L
,''L M
nullable''N V
:''V W
true''X \
)''\ ]
,''] ^ 
PhoneNumberConfirmed(( (
=(() *
table((+ 0
.((0 1
Column((1 7
<((7 8
bool((8 <
>((< =
(((= >
type((> B
:((B C
$str((D I
,((I J
nullable((K S
:((S T
false((U Z
)((Z [
,(([ \
TwoFactorEnabled)) $
=))% &
table))' ,
.)), -
Column))- 3
<))3 4
bool))4 8
>))8 9
())9 :
type)): >
:))> ?
$str))@ E
,))E F
nullable))G O
:))O P
false))Q V
)))V W
,))W X

LockoutEnd** 
=**  
table**! &
.**& '
Column**' -
<**- .
DateTimeOffset**. <
>**< =
(**= >
type**> B
:**B C
$str**D T
,**T U
nullable**V ^
:**^ _
true**` d
)**d e
,**e f
LockoutEnabled++ "
=++# $
table++% *
.++* +
Column+++ 1
<++1 2
bool++2 6
>++6 7
(++7 8
type++8 <
:++< =
$str++> C
,++C D
nullable++E M
:++M N
false++O T
)++T U
,++U V
AccessFailedCount,, %
=,,& '
table,,( -
.,,- .
Column,,. 4
<,,4 5
int,,5 8
>,,8 9
(,,9 :
type,,: >
:,,> ?
$str,,@ E
,,,E F
nullable,,G O
:,,O P
false,,Q V
),,V W
}-- 
,-- 
constraints.. 
:.. 
table.. "
=>..# %
{// 
table00 
.00 

PrimaryKey00 $
(00$ %
$str00% 5
,005 6
x007 8
=>009 ;
x00< =
.00= >
Id00> @
)00@ A
;00A B
}11 
)11 
;11 
migrationBuilder33 
.33 
CreateTable33 (
(33( )
name44 
:44 
$str44 (
,44( )
columns55 
:55 
table55 
=>55 !
new55" %
{66 
Id77 
=77 
table77 
.77 
Column77 %
<77% &
int77& )
>77) *
(77* +
type77+ /
:77/ 0
$str771 6
,776 7
nullable778 @
:77@ A
false77B G
)77G H
.88 

Annotation88 #
(88# $
$str88$ 8
,888 9
$str88: @
)88@ A
,88A B
RoleId99 
=99 
table99 "
.99" #
Column99# )
<99) *
string99* 0
>990 1
(991 2
type992 6
:996 7
$str998 G
,99G H
nullable99I Q
:99Q R
false99S X
)99X Y
,99Y Z
	ClaimType:: 
=:: 
table::  %
.::% &
Column::& ,
<::, -
string::- 3
>::3 4
(::4 5
type::5 9
:::9 :
$str::; J
,::J K
nullable::L T
:::T U
true::V Z
)::Z [
,::[ \

ClaimValue;; 
=;;  
table;;! &
.;;& '
Column;;' -
<;;- .
string;;. 4
>;;4 5
(;;5 6
type;;6 :
:;;: ;
$str;;< K
,;;K L
nullable;;M U
:;;U V
true;;W [
);;[ \
}<< 
,<< 
constraints== 
:== 
table== "
=>==# %
{>> 
table?? 
.?? 

PrimaryKey?? $
(??$ %
$str??% :
,??: ;
x??< =
=>??> @
x??A B
.??B C
Id??C E
)??E F
;??F G
table@@ 
.@@ 

ForeignKey@@ $
(@@$ %
nameAA 
:AA 
$strAA F
,AAF G
columnBB 
:BB 
xBB  !
=>BB" $
xBB% &
.BB& '
RoleIdBB' -
,BB- .
principalTableCC &
:CC& '
$strCC( 5
,CC5 6
principalColumnDD '
:DD' (
$strDD) -
,DD- .
onDeleteEE  
:EE  !
ReferentialActionEE" 3
.EE3 4
CascadeEE4 ;
)EE; <
;EE< =
}FF 
)FF 
;FF 
migrationBuilderHH 
.HH 
CreateTableHH (
(HH( )
nameII 
:II 
$strII (
,II( )
columnsJJ 
:JJ 
tableJJ 
=>JJ !
newJJ" %
{KK 
IdLL 
=LL 
tableLL 
.LL 
ColumnLL %
<LL% &
intLL& )
>LL) *
(LL* +
typeLL+ /
:LL/ 0
$strLL1 6
,LL6 7
nullableLL8 @
:LL@ A
falseLLB G
)LLG H
.MM 

AnnotationMM #
(MM# $
$strMM$ 8
,MM8 9
$strMM: @
)MM@ A
,MMA B
UserIdNN 
=NN 
tableNN "
.NN" #
ColumnNN# )
<NN) *
stringNN* 0
>NN0 1
(NN1 2
typeNN2 6
:NN6 7
$strNN8 G
,NNG H
nullableNNI Q
:NNQ R
falseNNS X
)NNX Y
,NNY Z
	ClaimTypeOO 
=OO 
tableOO  %
.OO% &
ColumnOO& ,
<OO, -
stringOO- 3
>OO3 4
(OO4 5
typeOO5 9
:OO9 :
$strOO; J
,OOJ K
nullableOOL T
:OOT U
trueOOV Z
)OOZ [
,OO[ \

ClaimValuePP 
=PP  
tablePP! &
.PP& '
ColumnPP' -
<PP- .
stringPP. 4
>PP4 5
(PP5 6
typePP6 :
:PP: ;
$strPP< K
,PPK L
nullablePPM U
:PPU V
truePPW [
)PP[ \
}QQ 
,QQ 
constraintsRR 
:RR 
tableRR "
=>RR# %
{SS 
tableTT 
.TT 

PrimaryKeyTT $
(TT$ %
$strTT% :
,TT: ;
xTT< =
=>TT> @
xTTA B
.TTB C
IdTTC E
)TTE F
;TTF G
tableUU 
.UU 

ForeignKeyUU $
(UU$ %
nameVV 
:VV 
$strVV F
,VVF G
columnWW 
:WW 
xWW  !
=>WW" $
xWW% &
.WW& '
UserIdWW' -
,WW- .
principalTableXX &
:XX& '
$strXX( 5
,XX5 6
principalColumnYY '
:YY' (
$strYY) -
,YY- .
onDeleteZZ  
:ZZ  !
ReferentialActionZZ" 3
.ZZ3 4
CascadeZZ4 ;
)ZZ; <
;ZZ< =
}[[ 
)[[ 
;[[ 
migrationBuilder]] 
.]] 
CreateTable]] (
(]]( )
name^^ 
:^^ 
$str^^ (
,^^( )
columns__ 
:__ 
table__ 
=>__ !
new__" %
{`` 
LoginProvideraa !
=aa" #
tableaa$ )
.aa) *
Columnaa* 0
<aa0 1
stringaa1 7
>aa7 8
(aa8 9
typeaa9 =
:aa= >
$straa? N
,aaN O
nullableaaP X
:aaX Y
falseaaZ _
)aa_ `
,aa` a
ProviderKeybb 
=bb  !
tablebb" '
.bb' (
Columnbb( .
<bb. /
stringbb/ 5
>bb5 6
(bb6 7
typebb7 ;
:bb; <
$strbb= L
,bbL M
nullablebbN V
:bbV W
falsebbX ]
)bb] ^
,bb^ _
ProviderDisplayNamecc '
=cc( )
tablecc* /
.cc/ 0
Columncc0 6
<cc6 7
stringcc7 =
>cc= >
(cc> ?
typecc? C
:ccC D
$strccE T
,ccT U
nullableccV ^
:cc^ _
truecc` d
)ccd e
,cce f
UserIddd 
=dd 
tabledd "
.dd" #
Columndd# )
<dd) *
stringdd* 0
>dd0 1
(dd1 2
typedd2 6
:dd6 7
$strdd8 G
,ddG H
nullableddI Q
:ddQ R
falseddS X
)ddX Y
}ee 
,ee 
constraintsff 
:ff 
tableff "
=>ff# %
{gg 
tablehh 
.hh 

PrimaryKeyhh $
(hh$ %
$strhh% :
,hh: ;
xhh< =
=>hh> @
newhhA D
{hhE F
xhhG H
.hhH I
LoginProviderhhI V
,hhV W
xhhX Y
.hhY Z
ProviderKeyhhZ e
}hhf g
)hhg h
;hhh i
tableii 
.ii 

ForeignKeyii $
(ii$ %
namejj 
:jj 
$strjj F
,jjF G
columnkk 
:kk 
xkk  !
=>kk" $
xkk% &
.kk& '
UserIdkk' -
,kk- .
principalTablell &
:ll& '
$strll( 5
,ll5 6
principalColumnmm '
:mm' (
$strmm) -
,mm- .
onDeletenn  
:nn  !
ReferentialActionnn" 3
.nn3 4
Cascadenn4 ;
)nn; <
;nn< =
}oo 
)oo 
;oo 
migrationBuilderqq 
.qq 
CreateTableqq (
(qq( )
namerr 
:rr 
$strrr '
,rr' (
columnsss 
:ss 
tabless 
=>ss !
newss" %
{tt 
UserIduu 
=uu 
tableuu "
.uu" #
Columnuu# )
<uu) *
stringuu* 0
>uu0 1
(uu1 2
typeuu2 6
:uu6 7
$struu8 G
,uuG H
nullableuuI Q
:uuQ R
falseuuS X
)uuX Y
,uuY Z
RoleIdvv 
=vv 
tablevv "
.vv" #
Columnvv# )
<vv) *
stringvv* 0
>vv0 1
(vv1 2
typevv2 6
:vv6 7
$strvv8 G
,vvG H
nullablevvI Q
:vvQ R
falsevvS X
)vvX Y
}ww 
,ww 
constraintsxx 
:xx 
tablexx "
=>xx# %
{yy 
tablezz 
.zz 

PrimaryKeyzz $
(zz$ %
$strzz% 9
,zz9 :
xzz; <
=>zz= ?
newzz@ C
{zzD E
xzzF G
.zzG H
UserIdzzH N
,zzN O
xzzP Q
.zzQ R
RoleIdzzR X
}zzY Z
)zzZ [
;zz[ \
table{{ 
.{{ 

ForeignKey{{ $
({{$ %
name|| 
:|| 
$str|| E
,||E F
column}} 
:}} 
x}}  !
=>}}" $
x}}% &
.}}& '
RoleId}}' -
,}}- .
principalTable~~ &
:~~& '
$str~~( 5
,~~5 6
principalColumn '
:' (
$str) -
,- .
onDelete
ÄÄ  
:
ÄÄ  !
ReferentialAction
ÄÄ" 3
.
ÄÄ3 4
Cascade
ÄÄ4 ;
)
ÄÄ; <
;
ÄÄ< =
table
ÅÅ 
.
ÅÅ 

ForeignKey
ÅÅ $
(
ÅÅ$ %
name
ÇÇ 
:
ÇÇ 
$str
ÇÇ E
,
ÇÇE F
column
ÉÉ 
:
ÉÉ 
x
ÉÉ  !
=>
ÉÉ" $
x
ÉÉ% &
.
ÉÉ& '
UserId
ÉÉ' -
,
ÉÉ- .
principalTable
ÑÑ &
:
ÑÑ& '
$str
ÑÑ( 5
,
ÑÑ5 6
principalColumn
ÖÖ '
:
ÖÖ' (
$str
ÖÖ) -
,
ÖÖ- .
onDelete
ÜÜ  
:
ÜÜ  !
ReferentialAction
ÜÜ" 3
.
ÜÜ3 4
Cascade
ÜÜ4 ;
)
ÜÜ; <
;
ÜÜ< =
}
áá 
)
áá 
;
áá 
migrationBuilder
ââ 
.
ââ 
CreateTable
ââ (
(
ââ( )
name
ää 
:
ää 
$str
ää (
,
ää( )
columns
ãã 
:
ãã 
table
ãã 
=>
ãã !
new
ãã" %
{
åå 
UserId
çç 
=
çç 
table
çç "
.
çç" #
Column
çç# )
<
çç) *
string
çç* 0
>
çç0 1
(
çç1 2
type
çç2 6
:
çç6 7
$str
çç8 G
,
ççG H
nullable
ççI Q
:
ççQ R
false
ççS X
)
ççX Y
,
ççY Z
LoginProvider
éé !
=
éé" #
table
éé$ )
.
éé) *
Column
éé* 0
<
éé0 1
string
éé1 7
>
éé7 8
(
éé8 9
type
éé9 =
:
éé= >
$str
éé? N
,
ééN O
nullable
ééP X
:
ééX Y
false
ééZ _
)
éé_ `
,
éé` a
Name
èè 
=
èè 
table
èè  
.
èè  !
Column
èè! '
<
èè' (
string
èè( .
>
èè. /
(
èè/ 0
type
èè0 4
:
èè4 5
$str
èè6 E
,
èèE F
nullable
èèG O
:
èèO P
false
èèQ V
)
èèV W
,
èèW X
Value
êê 
=
êê 
table
êê !
.
êê! "
Column
êê" (
<
êê( )
string
êê) /
>
êê/ 0
(
êê0 1
type
êê1 5
:
êê5 6
$str
êê7 F
,
êêF G
nullable
êêH P
:
êêP Q
true
êêR V
)
êêV W
}
ëë 
,
ëë 
constraints
íí 
:
íí 
table
íí "
=>
íí# %
{
ìì 
table
îî 
.
îî 

PrimaryKey
îî $
(
îî$ %
$str
îî% :
,
îî: ;
x
îî< =
=>
îî> @
new
îîA D
{
îîE F
x
îîG H
.
îîH I
UserId
îîI O
,
îîO P
x
îîQ R
.
îîR S
LoginProvider
îîS `
,
îî` a
x
îîb c
.
îîc d
Name
îîd h
}
îîi j
)
îîj k
;
îîk l
table
ïï 
.
ïï 

ForeignKey
ïï $
(
ïï$ %
name
ññ 
:
ññ 
$str
ññ F
,
ññF G
column
óó 
:
óó 
x
óó  !
=>
óó" $
x
óó% &
.
óó& '
UserId
óó' -
,
óó- .
principalTable
òò &
:
òò& '
$str
òò( 5
,
òò5 6
principalColumn
ôô '
:
ôô' (
$str
ôô) -
,
ôô- .
onDelete
öö  
:
öö  !
ReferentialAction
öö" 3
.
öö3 4
Cascade
öö4 ;
)
öö; <
;
öö< =
}
õõ 
)
õõ 
;
õõ 
migrationBuilder
ùù 
.
ùù 
CreateIndex
ùù (
(
ùù( )
name
ûû 
:
ûû 
$str
ûû 2
,
ûû2 3
table
üü 
:
üü 
$str
üü )
,
üü) *
column
†† 
:
†† 
$str
††  
)
††  !
;
††! "
migrationBuilder
¢¢ 
.
¢¢ 
CreateIndex
¢¢ (
(
¢¢( )
name
££ 
:
££ 
$str
££ %
,
££% &
table
§§ 
:
§§ 
$str
§§ $
,
§§$ %
column
•• 
:
•• 
$str
•• (
,
••( )
unique
¶¶ 
:
¶¶ 
true
¶¶ 
,
¶¶ 
filter
ßß 
:
ßß 
$str
ßß 6
)
ßß6 7
;
ßß7 8
migrationBuilder
©© 
.
©© 
CreateIndex
©© (
(
©©( )
name
™™ 
:
™™ 
$str
™™ 2
,
™™2 3
table
´´ 
:
´´ 
$str
´´ )
,
´´) *
column
¨¨ 
:
¨¨ 
$str
¨¨  
)
¨¨  !
;
¨¨! "
migrationBuilder
ÆÆ 
.
ÆÆ 
CreateIndex
ÆÆ (
(
ÆÆ( )
name
ØØ 
:
ØØ 
$str
ØØ 2
,
ØØ2 3
table
∞∞ 
:
∞∞ 
$str
∞∞ )
,
∞∞) *
column
±± 
:
±± 
$str
±±  
)
±±  !
;
±±! "
migrationBuilder
≥≥ 
.
≥≥ 
CreateIndex
≥≥ (
(
≥≥( )
name
¥¥ 
:
¥¥ 
$str
¥¥ 1
,
¥¥1 2
table
µµ 
:
µµ 
$str
µµ (
,
µµ( )
column
∂∂ 
:
∂∂ 
$str
∂∂  
)
∂∂  !
;
∂∂! "
migrationBuilder
∏∏ 
.
∏∏ 
CreateIndex
∏∏ (
(
∏∏( )
name
ππ 
:
ππ 
$str
ππ "
,
ππ" #
table
∫∫ 
:
∫∫ 
$str
∫∫ $
,
∫∫$ %
column
ªª 
:
ªª 
$str
ªª )
)
ªª) *
;
ªª* +
migrationBuilder
ΩΩ 
.
ΩΩ 
CreateIndex
ΩΩ (
(
ΩΩ( )
name
ææ 
:
ææ 
$str
ææ %
,
ææ% &
table
øø 
:
øø 
$str
øø $
,
øø$ %
column
¿¿ 
:
¿¿ 
$str
¿¿ ,
,
¿¿, -
unique
¡¡ 
:
¡¡ 
true
¡¡ 
,
¡¡ 
filter
¬¬ 
:
¬¬ 
$str
¬¬ :
)
¬¬: ;
;
¬¬; <
}
√√ 	
	protected
≈≈ 
override
≈≈ 
void
≈≈ 
Down
≈≈  $
(
≈≈$ %
MigrationBuilder
≈≈% 5
migrationBuilder
≈≈6 F
)
≈≈F G
{
∆∆ 	
migrationBuilder
«« 
.
«« 
	DropTable
«« &
(
««& '
name
»» 
:
»» 
$str
»» (
)
»»( )
;
»») *
migrationBuilder
   
.
   
	DropTable
   &
(
  & '
name
ÀÀ 
:
ÀÀ 
$str
ÀÀ (
)
ÀÀ( )
;
ÀÀ) *
migrationBuilder
ÕÕ 
.
ÕÕ 
	DropTable
ÕÕ &
(
ÕÕ& '
name
ŒŒ 
:
ŒŒ 
$str
ŒŒ (
)
ŒŒ( )
;
ŒŒ) *
migrationBuilder
–– 
.
–– 
	DropTable
–– &
(
––& '
name
—— 
:
—— 
$str
—— '
)
——' (
;
——( )
migrationBuilder
”” 
.
”” 
	DropTable
”” &
(
””& '
name
‘‘ 
:
‘‘ 
$str
‘‘ (
)
‘‘( )
;
‘‘) *
migrationBuilder
÷÷ 
.
÷÷ 
	DropTable
÷÷ &
(
÷÷& '
name
◊◊ 
:
◊◊ 
$str
◊◊ #
)
◊◊# $
;
◊◊$ %
migrationBuilder
ŸŸ 
.
ŸŸ 
	DropTable
ŸŸ &
(
ŸŸ& '
name
⁄⁄ 
:
⁄⁄ 
$str
⁄⁄ #
)
⁄⁄# $
;
⁄⁄$ %
}
€€ 	
}
‹‹ 
}›› Å
p/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Migrations/20211230213358_AddFirstLastNameToUser.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "

Migrations" ,
{ 
public 

partial 
class "
AddFirstLastNameToUser /
:0 1
	Migration2 ;
{ 
	protected		 
override		 
void		 
Up		  "
(		" #
MigrationBuilder		# 3
migrationBuilder		4 D
)		D E
{

 	
migrationBuilder 
. 
	AddColumn &
<& '
string' -
>- .
(. /
name 
: 
$str !
,! "
table 
: 
$str $
,$ %
type 
: 
$str %
,% &
nullable 
: 
false 
,  
defaultValue 
: 
$str  
)  !
;! "
migrationBuilder 
. 
	AddColumn &
<& '
string' -
>- .
(. /
name 
: 
$str  
,  !
table 
: 
$str $
,$ %
type 
: 
$str %
,% &
nullable 
: 
false 
,  
defaultValue 
: 
$str  
)  !
;! "
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 

DropColumn '
(' (
name 
: 
$str !
,! "
table 
: 
$str $
)$ %
;% &
migrationBuilder   
.   

DropColumn   '
(  ' (
name!! 
:!! 
$str!!  
,!!  !
table"" 
:"" 
$str"" $
)""$ %
;""% &
}## 	
}$$ 
}%% ∫
V/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Models/ApplicationUser.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "
Models" (
;( )
public 
class 
ApplicationUser 
: 
IdentityUser *
{ 
public 

string 
	FirstName 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
LastName 
{ 
get  
;  !
set" %
;% &
}' (
}		 ‰
U/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Models/ErrorViewModel.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
.! "
Models" (
;( )
public 
class 
ErrorViewModel 
{ 
public 

string 
? 
	RequestId 
{ 
get "
;" #
set$ '
;' (
}) *
public 

bool 
ShowRequestId 
=>  
!! "
string" (
.( )
IsNullOrEmpty) 6
(6 7
	RequestId7 @
)@ A
;A B
} ë+
G/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Program.cs
var

 
builder

 
=

 
WebApplication

 
.

 
CreateBuilder

 *
(

* +
args

+ /
)

/ 0
;

0 1
var 
connectionString 
= 
builder 
. 
Configuration ,
., -
GetConnectionString- @
(@ A
$strA T
)T U
;U V
builder 
. 
Services 
. 
AddDbContext 
<  
ApplicationDbContext 2
>2 3
(3 4
options4 ;
=>< >
options 
. 
UseSqlServer 
( 
connectionString )
)) *
)* +
;+ ,
builder 
. 
Services 
. 
AddIdentity 
< 
ApplicationUser ,
,, -
IdentityRole. :
>: ;
(; <
)< =
. $
AddEntityFrameworkStores 
<  
ApplicationDbContext 2
>2 3
(3 4
)4 5
.5 6$
AddDefaultTokenProviders6 N
(N O
)O P
;P Q
builder 
. 
Services 
. 
AddIdentityServer "
(" #
options# *
=>+ -
{ 
options 
. 
Events 
. 
RaiseErrorEvents '
=( )
true* .
;. /
options 
. 
Events 
. "
RaiseInformationEvents -
=. /
true0 4
;4 5
options 
. 
Events 
. 
RaiseFailureEvents )
=* +
true, 0
;0 1
options 
. 
Events 
. 
RaiseSuccessEvents )
=* +
true, 0
;0 1
options 
. #
EmitStaticAudienceClaim '
=( )
true* .
;. /
} 
) 
. (
AddInMemoryIdentityResources #
(# $
SD$ &
.& '
IdentityResources' 8
)8 9
.  
AddInMemoryApiScopes 
( 
SD 
. 
	ApiScopes &
)& '
. 
AddInMemoryClients 
( 
SD 
. 
Clients "
)" #
. 
AddAspNetIdentity 
< 
ApplicationUser &
>& '
(' (
)( )
.   )
AddDeveloperSigningCredential   "
(  " #
)  # $
;  $ %
builder"" 
."" 
Services"" 
."" 
	AddScoped"" 
<"" 
IDbInitializer"" )
,"") *
DbInitializer""+ 8
>""8 9
(""9 :
)"": ;
;""; <
builder## 
.## 
Services## 
.## 
	AddScoped## 
<## 
IProfileService## *
,##* +
ProfileService##, :
>##: ;
(##; <
)##< =
;##= >
builder%% 
.%% 
Services%% 
.%% #
AddControllersWithViews%% (
(%%( )
)%%) *
;%%* +
var'' 
app'' 
='' 	
builder''
 
.'' 
Build'' 
('' 
)'' 
;'' 
var(( 
scope(( 	
=((
 
app(( 
.(( 
Services(( 
.(( 
CreateScope(( $
((($ %
)((% &
;((& '
var)) 
dbInitializer)) 
=)) 
scope)) 
.)) 
ServiceProvider)) )
.))) *

GetService))* 4
<))4 5
IDbInitializer))5 C
>))C D
())D E
)))E F
;))F G
if,, 
(,, 
!,, 
app,, 
.,, 	
Environment,,	 
.,, 
IsDevelopment,, "
(,," #
),,# $
),,$ %
{-- 
app.. 
... 
UseExceptionHandler.. 
(.. 
$str.. )
)..) *
;..* +
app00 
.00 
UseHsts00 
(00 
)00 
;00 
}11 
app33 
.33 
UseHttpsRedirection33 
(33 
)33 
;33 
app44 
.44 
UseStaticFiles44 
(44 
)44 
;44 
app66 
.66 

UseRouting66 
(66 
)66 
;66 
app88 
.88 
UseIdentityServer88 
(88 
)88 
;88 
app:: 
.:: 
UseAuthorization:: 
(:: 
):: 
;:: 
dbInitializer<< 
.<< 

Initialize<< 
(<< 
)<< 
;<< 
app?? 
.?? 
MapControllerRoute?? 
(?? 
name@@ 
:@@ 	
$str@@
 
,@@ 
patternAA 
:AA 
$strAA 5
)AA5 6
;AA6 7
appCC 
.CC 
RunCC 
(CC 
)CC 	
;CC	 
≈!
B/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/SD.cs
	namespace 	
Mango
 
. 
Services 
. 
Identity !
;! "
public 
static 
class 
SD 
{ 
public 

const 
string 
Admin 
= 
$str  '
;' (
public		 

const		 
string		 
Customer		  
=		! "
$str		# -
;		- .
public 

static 
IEnumerable 
< 
IdentityResource .
>. /
IdentityResources0 A
=>B D
new 
List 
< 
IdentityResource !
>! "
{ 	
new 
IdentityResources !
.! "
OpenId" (
(( )
)) *
,* +
new 
IdentityResources !
.! "
Email" '
(' (
)( )
,) *
new 
IdentityResources !
.! "
Profile" )
() *
)* +
} 	
;	 

public 

static 
IEnumerable 
< 
ApiScope &
>& '
	ApiScopes( 1
=>2 4
new 
List 
< 
ApiScope 
> 
{ 	
new 
ApiScope 
( 
$str  
,  !
$str" /
)/ 0
,0 1
new 
ApiScope 
( 
$str 
,  
$str! -
)- .
,. /
new 
ApiScope 
( 
$str  
,  !
$str" /
)/ 0
,0 1
new 
ApiScope 
( 
$str !
,! "
$str# 1
)1 2
} 	
;	 

public 

static 
IEnumerable 
< 
Client $
>$ %
Clients& -
=>. 0
new 
List 
< 
Client 
> 
{ 	
new 
Client 
{   
ClientId!! 
=!! 
$str!! #
,!!# $
ClientSecrets"" 
="" 
{""  !
new""" %
Secret""& ,
("", -
$str""- 5
.""5 6
Sha256""6 <
(""< =
)""= >
)""> ?
}""@ A
,""A B
AllowedGrantTypes## !
=##" #

GrantTypes##$ .
.##. /
ClientCredentials##/ @
,##@ A
AllowedScopes$$ 
=$$ 
{$$  !
$str$$" (
,$$( )
$str$$* 1
,$$1 2
$str$$3 <
}$$= >
}%% 
,%% 
new&& 
Client&& 
{'' 
ClientId(( 
=(( 
$str(( "
,((" #
ClientSecrets)) 
=)) 
{))  !
new))" %
Secret))& ,
()), -
$str))- 5
.))5 6
Sha256))6 <
())< =
)))= >
)))> ?
}))@ A
,))A B
AllowedGrantTypes** !
=**" #

GrantTypes**$ .
.**. /
Code**/ 3
,**3 4
RedirectUris++ 
=++ 
{++  
$str++! E
}++F G
,++G H"
PostLogoutRedirectUris,, &
=,,' (
{,,) *
$str,,+ Y
},,Z [
,,,[ \
AllowedScopes-- 
=-- 
new--  #
List--$ (
<--( )
string--) /
>--/ 0
{.. #
IdentityServerConstants// +
.//+ ,
StandardScopes//, :
.//: ;
OpenId//; A
,//A B#
IdentityServerConstants00 +
.00+ ,
StandardScopes00, :
.00: ;
Profile00; B
,00B C#
IdentityServerConstants11 +
.11+ ,
StandardScopes11, :
.11: ;
Email11; @
,11@ A
$str22 
}33 
}44 
,44 
}55 	
;55	 

}66 ı/
W/home/manuel/sources/MangoRestaurant/Mango.Services.Identity/Services/ProfileService.cs
	namespace		 	
Mango		
 
.		 
Services		 
.		 
Identity		 !
.		! "
Services		" *
;		* +
public 
class 
ProfileService 
: 
IProfileService ,
{ 
private 
readonly '
IUserClaimsPrincipalFactory 4
<4 5
ApplicationUser5 D
>D E'
_userClaimsPrincipalFactoryF a
;a b
private 
readonly 
UserManager $
<$ %
ApplicationUser% 4
>4 5
_userMgr6 >
;> ?
private 
readonly 
RoleManager $
<$ %
IdentityRole% 1
>1 2
_roleMgr3 ;
;; <
public 
ProfileService 
( 
UserManager 
< 
ApplicationUser '
>' (
userMgr) 0
,0 1
RoleManager 
< 
IdentityRole $
>$ %
roleMgr& -
,- .'
IUserClaimsPrincipalFactory '
<' (
ApplicationUser( 7
>7 8&
userClaimsPrincipalFactory9 S
)S T
{ 	
_userMgr 
= 
userMgr 
; 
_roleMgr 
= 
roleMgr 
; '
_userClaimsPrincipalFactory '
=( )&
userClaimsPrincipalFactory* D
;D E
} 	
public 
async 
Task 
GetProfileDataAsync -
(- .%
ProfileDataRequestContext. G
contextH O
)O P
{ 	
string 
sub 
= 
context  
.  !
Subject! (
.( )
GetSubjectId) 5
(5 6
)6 7
;7 8
ApplicationUser 
user  
=! "
await# (
_userMgr) 1
.1 2
FindByIdAsync2 ?
(? @
sub@ C
)C D
;D E
ClaimsPrincipal   

userClaims   &
=  ' (
await  ) .'
_userClaimsPrincipalFactory  / J
.  J K
CreateAsync  K V
(  V W
user  W [
)  [ \
;  \ ]
List## 
<## 
Claim## 
>## 
claims## 
=##  

userClaims##! +
.##+ ,
Claims##, 2
.##2 3
ToList##3 9
(##9 :
)##: ;
;##; <
claims$$ 
=$$ 
claims$$ 
.$$ 
Where$$ !
($$! "
claim$$" '
=>$$( *
context$$+ 2
.$$2 3
RequestedClaimTypes$$3 F
.$$F G
Contains$$G O
($$O P
claim$$P U
.$$U V
Type$$V Z
)$$Z [
)$$[ \
.$$\ ]
ToList$$] c
($$c d
)$$d e
;$$e f
claims%% 
.%% 
Add%% 
(%% 
new%% 
Claim%%  
(%%  !
JwtClaimTypes%%! .
.%%. /

FamilyName%%/ 9
,%%9 :
user%%; ?
.%%? @
LastName%%@ H
)%%H I
)%%I J
;%%J K
claims&& 
.&& 
Add&& 
(&& 
new&& 
Claim&&  
(&&  !
JwtClaimTypes&&! .
.&&. /
	GivenName&&/ 8
,&&8 9
user&&: >
.&&> ?
	FirstName&&? H
)&&H I
)&&I J
;&&J K
if'' 
('' 
_userMgr'' 
.'' 
SupportsUserRole'' )
)'') *
{(( 
IList)) 
<)) 
string)) 
>)) 
roles)) #
=))$ %
await))& +
_userMgr)), 4
.))4 5
GetRolesAsync))5 B
())B C
user))C G
)))G H
;))H I
foreach** 
(** 
var** 
rolename** $
in**% '
roles**( -
)**- .
{++ 
claims,, 
.,, 
Add,, 
(,, 
new,, "
Claim,,# (
(,,( )
JwtClaimTypes,,) 6
.,,6 7
Role,,7 ;
,,,; <
rolename,,= E
),,E F
),,F G
;,,G H
if-- 
(-- 
_roleMgr--  
.--  !
SupportsRoleClaims--! 3
)--3 4
{.. 
IdentityRole// $
role//% )
=//* +
await//, 1
_roleMgr//2 :
.//: ;
FindByNameAsync//; J
(//J K
rolename//K S
)//S T
;//T U
if00 
(00 
role00  
!=00! #
null00$ (
)00( )
{11 
claims22 "
.22" #
AddRange22# +
(22+ ,
await22, 1
_roleMgr222 :
.22: ;
GetClaimsAsync22; I
(22I J
role22J N
)22N O
)22O P
;22P Q
}33 
}44 
}55 
}66 
context88 
.88 
IssuedClaims88  
=88! "
claims88# )
;88) *
}99 	
public;; 
async;; 
Task;; 
IsActiveAsync;; '
(;;' (
IsActiveContext;;( 7
context;;8 ?
);;? @
{<< 	
string== 
sub== 
=== 
context==  
.==  !
Subject==! (
.==( )
GetSubjectId==) 5
(==5 6
)==6 7
;==7 8
ApplicationUser>> 
user>>  
=>>! "
await>># (
_userMgr>>) 1
.>>1 2
FindByIdAsync>>2 ?
(>>? @
sub>>@ C
)>>C D
;>>D E
context?? 
.?? 
IsActive?? 
=?? 
user?? #
!=??$ &
null??' +
;??+ ,
}@@ 	
}AA 